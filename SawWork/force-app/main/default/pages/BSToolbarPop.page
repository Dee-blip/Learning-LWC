<apex:page showHeader="false" title="New Call" controller="BSScreenPopPageController">

<apex:includeScript value="/support/console/39.0/integration.js"/>
<apex:includeScript value="/soap/ajax/39.0/connection.js"/>

<apex:includeLightning />
<apex:includeScript value="{!URLFOR($Resource.cnx__CnxSfdcResources,'js/ConnectsIntegrationAPI.min.js')}"/>


<select id="testsel">
<option value="billing_nocontact">Billing - No Contact</option>
<option value="billing_contact">Billing - Contact Found</option>
<option value="marketing_nomatch">Marketing - No Match</option>
<option value="marketing_matchnoc2a">Marketing - Match (no C2A)</option>
<option value="marketing_matchc2afound">Marketing - Match, C2A found</option>
<option value="akatec">Akatec</option>

</select>

<script>

console.log('loaded');

</script>



<input type="button" onclick="runtesting()" value="run test"/>


<script>
    ConnectsIntegrationAPI.waitReady(function () {


        ConnectsIntegrationAPI.onAgentStateChange = function(event) {
            console.log('changed stated');
        }

        ConnectsIntegrationAPI.onActivitySave = function(event) {
    
            // pv4 contains ERC code where applicable
            // pv1 has lob
            
            // helpdesk, nocc, socc, billing   
            if (event.created && event.item.CallType =='PREROUTE_ACD_IN') {
            
            	console.log('THIS IS A NEW CALL!!!!');
            	console.log(event);
                
                var csid= '';
                var erccode = '';
                
                for (xzi = 0; xzi < event.item.NamedVariables.length; xzi++) {
                    if (event.item.NamedVariables[xzi].Key == 'user.caseid') {
                        csid = event.item.NamedVariables[xzi].Value;
                    }
               	}
                if (event.item.PerVar4 != '') {
                    erccode = event.item.PerVar4;
                }
                //ACD2-329 - Changes By Harshil
                //Added second part of if-condition to avoid screenpop for non-english
                //ACD2-477 - Changes By Harshil
                //Added condition to avoid screenpop for SOCC internal calls
                if (event.item.PerVar1 != 'SOCC Management' && !(event.item.PerVar1.startsWith('AkaTec') && event.item.PerVar2 != 'English') 
                    && !(event.item.PerVar6 == 'AKA_AKT_ENG_GONET') && !(event.item.PerVar6.toLowerCase().includes('AKA_SOCC_SA_Escalation'.toLowerCase()))) {
                    
                    screenPopByLob(event.item.PerVar1,event.item.Sender,erccode,csid,event.recordId);
                    
                }
                
            }
            
    
        }
    });
    
    function screenPopByLob(lob, ani, erc,csidnum,tskid) {
    		aninoplus1 = ani.replace('+1','');
        
      	    if (lob.startsWith('SOCC')) {
                console.log('running prepop check');
                runprepop(lob,aninoplus1,erc,tskid);
               
            } else {
                
                var milliseconds = Math.floor((new Date).getTime()/1000);
                var method='custom';
                var testpop='/apex/BSScreenPopPage?lob=' + lob + '&taskid=' + tskid + '&ani=' + aninoplus1 + '&erc=' + erc + '&caseid=' + csidnum + '&method=' + method + '&t=' +milliseconds;
        
                ConnectsIntegrationAPI.screenPop(testpop); 
    		}
        
    }



</script>
<apex:form >

    <apex:outputPanel id="lcform">
        <script>
        
        var popId = '{!idToPop}';
        
        if (popId != '' && popId != 'NewLead') {
            ConnectsIntegrationAPI.screenPop(popId);
        }
        
        if (popId == 'NewLead') {
            var milliseconds = Math.floor((new Date).getTime()/1000);

           var testpop='/apex/BSScreenPopPage?method=' + 'NewLead' + '&t=' +milliseconds;
             ConnectsIntegrationAPI.screenPop(testpop);
        }
        
        
        
        </script>
    
    
    </apex:outputPanel>

 	<apex:outputPanel id="prepopform">
        <script>
        
        var popSearchId = '{!valueToSearch}';
        
        
          if (popSearchId == 'standardpop') {
              var milliseconds = Math.floor((new Date).getTime()/1000);
                var method='custom';
                var testpop='/apex/BSScreenPopPage?lob=' + '{!lob}' + '&taskid=' + '{!taskid}' + '&ani=' + '{!ani}' + '&erc=' + '{!erc}' + '&method=' + '{!method}' + '&t=' +milliseconds;
        
                ConnectsIntegrationAPI.screenPop(testpop); 
           } else if (popSearchId != '')  {
              
                    ConnectsIntegrationAPI.screenPopToSearch(popSearchId);
            
          }
        
           
        
        </script>
    
    
    </apex:outputPanel>

    <apex:actionFunction action="{!runStandardPop}" name="runstandardpop" rerender="lcform">
        <apex:param name="param2" assignTo="{!lob}" value="" />
        <apex:param name="param1" assignTo="{!ani}" value="" />
        <apex:param name="param3" assignTo="{!erc}" value="" />
    </apex:actionFunction>
    
    
      <apex:actionFunction action="{!runPrePopCheck}" name="runprepop" rerender="prepopform">
        <apex:param name="param2" assignTo="{!lob}" value="" />
        <apex:param name="param1" assignTo="{!ani}" value="" />
        <apex:param name="param3" assignTo="{!erc}" value="" />
        <apex:param name="param4" assignTo="{!taskid}" value="" />
            
    </apex:actionFunction>
    
    
</apex:form>


</apex:page>