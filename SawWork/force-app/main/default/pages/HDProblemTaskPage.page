<!-- 
Modification Log
===============================================================
Date Author Modification
Line 94,134,136 12 Aug 2020, Amogh M P, PRTORES-1812 HD Code scan 2020 - Blockers, Criticals Part 6
--> 
<apex:page standardController="BMCServiceDesk__Task__c" sidebar="false" showHeader="false"  extensions="HD_ProblemTaskPage_Ctrl" id="prbtaskpage">
<apex:messages />
<apex:message />
<apex:form id="prbtskform" >
<apex:pageBlock title="Problem Task Details" id="prbtskformpageblock">

<apex:pageBlockButtons >
<apex:commandButton onclick="Close();return false;" value="Close"/>
<apex:commandButton onclick="scriptSave();return false;" value="Save"/>


</apex:pageBlockButtons>


<apex:pageBlockSection columns="2"  Title="Client Details" id="clientdetail">
<apex:pageBlockSectionItem id="clientdetailsecitem">{!$ObjectType.BMCServiceDesk__Task__c.fields.BMCServiceDesk__FKClient__c.label} <apex:inputField value="{!tsk1.BMCServiceDesk__FKClient__c}"    label="Name"  required="true" id="fkclient"/></apex:pageBlockSectionItem>

</apex:pageBlockSection>

<apex:pageBlockSection columns="2" Title="Task Details" id="tskdetails">

<apex:pageBlockSectionItem id="tskdetailssecitem1">{!$ObjectType.BMCServiceDesk__Task__c.fields.BMCServiceDesk__FKImpact__c.label}<apex:inputField value="{!tsk1.BMCServiceDesk__FKImpact__c}"     label="Name" id="fkimpact"/></apex:pageBlockSectionItem>
<apex:pageBlockSectionItem id="tskdetailssecitem2">{!$ObjectType.BMCServiceDesk__Task__c.fields.BMCServiceDesk__FKUrgency__c.label}<apex:inputField value="{!tsk1.BMCServiceDesk__FKUrgency__c}"     label="Name" id="fkurgency"/></apex:pageBlockSectionItem>

<apex:pageBlockSectionItem id="tskdetailssecitem3">{!$ObjectType.BMCServiceDesk__Task__c.fields.BMCServiceDesk__taskDescription__c.label}<apex:inputTextarea value="{!tsk1.BMCServiceDesk__taskDescription__c}"  style="width:90%"   label="Name" id="tskdesc"/></apex:pageBlockSectionItem>

<apex:pageBlockSectionItem id="tskdetailssecitem4">{!$ObjectType.BMCServiceDesk__Task__c.fields.BMCServiceDesk__FKProblem__c.label}<apex:inputField value="{!tsk1.BMCServiceDesk__FKProblem__c}"     label="Name" id="fkproblem"/></apex:pageBlockSectionItem>


</apex:pageBlockSection>



<apex:pageBlockSection columns="2"  Title="Task Date and Time Details" id="tskdatetimedetails">
<apex:pageBlockSectionItem id="tskdatetimedetailssection">{!$ObjectType.BMCServiceDesk__Task__c.fields.BMCServiceDesk__dueDateTime__c.label} <apex:inputField id="duedate" value="{!tsk1.BMCServiceDesk__dueDateTime__c}"    label="Name"  required="false"/></apex:pageBlockSectionItem>
</apex:pageBlockSection>
</apex:pageBlock>

</apex:form>

<!--- Calling Salesforce Ajax Library ----->
<script src="/soap/ajax/29.0/connection.js" type="text/javascript"></script>


<script language="JavaScript" type="text/javascript">
var __sfdcSessionId = '{!GETSESSIONID()}';

function scriptSave()
{
//start of object instance
var bmctask = new sforce.SObject("BMCServiceDesk__Task__c");


//setting object field values
bmctask.BMCServiceDesk__FKClient__c = document.getElementById('{!$Component.prbtaskpage:prbtskform:prbtskformpageblock:clientdetail:clientdetailsecitem:fkclient}_lkid').value;

bmctask.BMCServiceDesk__FKImpact__c = document.getElementById('{!$Component.prbtaskpage:prbtskform:prbtskformpageblock:tskdetails:tskdetailssecitem1:fkimpact}_lkid').value;
bmctask.BMCServiceDesk__FKUrgency__c = document.getElementById('{!$Component.prbtaskpage:prbtskform:prbtskformpageblock:tskdetails:tskdetailssecitem2:fkurgency}_lkid').value;
bmctask.BMCServiceDesk__taskDescription__c = document.getElementById('{!$Component.prbtaskpage:prbtskform:prbtskformpageblock:tskdetails:tskdetailssecitem3:tskdesc}').value;
bmctask.BMCServiceDesk__FKProblem__c = document.getElementById('{!$Component.prbtaskpage:prbtskform:prbtskformpageblock:tskdetails:tskdetailssecitem4:fkproblem}_lkid').value;

var duedate = document.getElementById('{!$Component.prbtaskpage:prbtskform:prbtskformpageblock:tskdatetimedetails:tskdatetimedetailssection:duedate}').value;
if( duedate != "")
{
 bmctask.BMCServiceDesk__dueDateTime__c = normalizeDate();
}

var ClientID = document.getElementById('{!$Component.prbtaskpage:prbtskform:prbtskformpageblock:clientdetail:clientdetailsecitem:fkclient}_lkid').value;
if ( ClientID != '')
{
sforce.connection.sessionId = __sfdcSessionId;
sforce.connection.create([bmctask],
{onSuccess : success, onFailure : failed});
function success(result) {
if (result[0].getBoolean("success")) {
//alert("new Task created with id " + result[0].id);
alert("Task with "+result[0].id +" has been processed succesfully, Please verify that all the fields has been entered correctly else the Task won't be created !");
CloseAndRefresh();
} else {
alert("failed to create Task" + result[0]);
}
}
function failed(error) {
alert("An error has occurred " + error);
}
}//if ( ClientID != '')
else{ alert('Client ID field is Empty or Client Not Found !'); }
return false;
}//function scriptSave()

 //function to close the popup window 
function Close()
{
 window.close();
 return false;
 }//function just for closing

//function for Date
function normalizeDate(){

   var mydate = document.getElementById('{!$Component.prbtaskpage:prbtskform:prbtskformpageblock:tskdatetimedetails:tskdatetimedetailssection:duedate}').value;
   var b = new Date();
   var pattern = /^(\d{1,2})\/(\d{1,2})\/(\d{4}) (\d{1,2}):(\d{1,2}) (AM|PM)$/;
   var re = new RegExp(pattern);
  
  try {
   //alert(mydate.split('/')[2].split(':')[0].split(' ')[1]);
   if(re.test(mydate) == true)
   {

   b.setDate(mydate.split('/')[1]);  
   b.setMonth(mydate.split('/')[0]-1); 
   b.setFullYear(mydate.split('/')[2].slice(0,4));
   b.setHours(mydate.split('/')[2].split(':')[0].split(' ')[1]);
   b.setMinutes(mydate.split('/')[2].split(':')[1].split(' ')[0]);
   b = b.toISOString(); 
   //alert(mydate.split('/')[0]-1);
   return b;
   }
   }
   catch(err)
   {
   alert('Error Occured : '+err);
   }//catch
    return '';
 }//normalizeDate
 
 
 //function to close and refresh parent window
function CloseAndRefresh()
{
try{
 //alert("Task has been processed succesfully, Please verify that all the fields has been entered correctly else the Task won't be created !");
 parent.window.opener.location.href="/{!$CurrentPage.parameters.probid}";
 window.parent.location.reload();
 window.close();

 }//try
 catch(err)
 {
 alert('Exception[]: '+err);
 }//catch
 return false;
 }//function to close an refresh parent window
 
 
</script>


</apex:page>