<apex:page standardController="BMCServiceDesk__Incident__c" showHeader="false" ID="srmdetail" extensions="HD_SRM_ServiceRequestDetails_Extension" docType="html-5.0" >
 <!----- Applying Stylesheets---->
<!-- Latest compiled and minified CSS -->
<apex:stylesheet value="{!URLFOR($Resource.HDscriptcss,'/bootstrapV3_3_0/css/bootstrap.min.css')}"/>
<!-- Define Tab panel .css styles -->
    <style>
    .activeTab {background-color: #236FBD; color:white; background-image:none}
    .inactiveTab { background-color: lightgrey; color:black; background-image:none}
    </style>
    
    <!---Navabar --->
<nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    <div class="navbar-header">
      <a class="navbar-brand" href="#">
        <apex:image url="{!URLFOR($Resource.HDscriptcss,'akamlogo.png')}" width="70" /> 
      </a>
      <p class="navbar-text navbar-right">Record Status : &nbsp;<apex:outputLink onclick="return false;" rendered="{!Record_Lock_flag}" styleClass="glyphicon glyphicon-lock" id="recordlock" title="Record is locked Due to active approval process"></apex:outputLink><apex:outputLink onclick="return false;" rendered="{!IF(NOT(Record_Lock_flag),true,false)}" styleClass="glyphicon glyphicon-pencil" id="recordedit"></apex:outputLink></p>
    </div>
  </div>
</nav>   

   <!-- Create Tab panel -->
    <apex:tabPanel switchType="client" selectedTab="name1" id="AccountTabPanel" tabClass="activeTab" inactiveTabClass="inactiveTab" rendered="true">
 <apex:tab label="Service Request Detail for #{!mysObject.Name}" name="name1" id="tabOne">
<apex:pageBlock id="messages"> <apex:messages styleClass="alert alert-warning"/><apex:message /></apex:pageBlock>      
 <apex:form id="Srmdetailform">
   <apex:actionFunction action="{!refreshRecord}" name="refreshobject" rendered="out,messages,AccountTabPanel" status="statusaction"/>
   <apex:actionFunction action="{!AjSave}"  name="saveaction" reRender="out,messages,srmdetailpageblock2,AccountTabPanel" status="statusaction" oncomplete="openservicerequest('{!SRMId}','{!reqdefId}','{!ClientId}');return false;" />
   
 <apex:pageBlock title="Service Request Detail for #{!mysObject.Name}" id="srmdetailpageblock" mode="inlineEdit" >
    <apex:pageBlockButtons location="both">
   <apex:commandLink styleClass="glyphicon glyphicon-refresh" title="Refresh Record" onclick="refreshobject();return false;"></apex:commandLink>&nbsp;
   <apex:commandButton value="Save"  disabled="{!IF(Record_Lock_flag,true,false)}" onclick="saveaction();return false;"></apex:commandButton> 
   <!--  apex:commandButton value="PURE Save"  disabled="{!IF(Record_Lock_flag,true,false)}" onclick="" Action="{!AjSave}"></apex:commandButton -->
   <apex:commandButton value="Service Request input"  disabled="{!IF(Record_Lock_flag,true,false)}" onclick="openservicerequest('{!SRMId}','{!reqdefId}','{!ClientId}');return false;"></apex:commandButton>


  <apex:actionStatus id="statusaction" startText="Busy...."><apex:facet name="start"><img src="{!URLFOR($Resource.HDscriptcss,'ajax-loader.gif')}" width="25"></img></apex:facet></apex:actionStatus>
 </apex:pageBlockButtons>

    
 <apex:pageBlockSection columns="2" collapsible="false" id="srmdetailpageblock2" showHeader="true" title="Client Details">
 <apex:pageBlockSectionItem helpText="{!$ObjectType.BMCServiceDesk__Incident__c.fields.BMCServiceDesk__FKClient__c.label}" id="clientidsectionitem"><apex:outputLabel >{!$ObjectType.BMCServiceDesk__Incident__c.fields.BMCServiceDesk__FKClient__c.label}</apex:outputLabel> <apex:inputField value="{!mysObject.BMCServiceDesk__FKClient__c}"  required="true" id="userIdVal"/></apex:pageBlockSectionItem>
 
 <apex:repeat value="{!$ObjectType.BMCServiceDesk__Incident__c.FieldSets.HD_SRM_Client_Details}" var="clientdetails">
 <apex:pageBlockSectionItem helpText="{!BMCServiceDesk__Incident__c[clientdetails]}"><apex:outputLabel >{!clientdetails.Label}</apex:outputLabel> <apex:inputField value="{!mysObject[clientdetails]}"  required="{!clientdetails.Required}"/></apex:pageBlockSectionItem>
 </apex:repeat>
 </apex:pageBlockSection>
 
  <apex:pageBlockSection columns="2" collapsible="false" id="srmdetailpageblock3" showHeader="true" title="Service Details">
   <apex:repeat value="{!$ObjectType.BMCServiceDesk__Incident__c.FieldSets.HD_SRM_Service_Details}"  var="servicedetails">
 <apex:pageBlockSectionItem rendered="{!IF(servicedetails.Label =='Service Offering' ,false,IF(servicedetails.Label =='Service',false,IF(servicedetails.Label =='Template',false,true)))}"><apex:outputLabel >{!IF(servicedetails.Label == 'Incident #','Service Request #',servicedetails.Label)}</apex:outputLabel> <apex:inputField value="{!mysObject[servicedetails]}"  required="{!servicedetails.Required}" /></apex:pageBlockSectionItem>
 </apex:repeat>
 </apex:pageBlockSection>
 
 <apex:pageBlockSection columns="2" collapsible="true" id="srmdetailpageblock4" showHeader="true" title="Status and Priority Details">

 <apex:repeat value="{!$ObjectType.BMCServiceDesk__Incident__c.FieldSets.HD_SRM_Status_and_details}" var="details">
 <apex:pageBlockSectionItem ><apex:outputLabel >{!details.Label}</apex:outputLabel> <apex:inputField value="{!mysObject[details]}"  required="{!details.Required}" /></apex:pageBlockSectionItem>
 </apex:repeat>
 </apex:pageBlockSection>
 
 <apex:pageBlockSection columns="2" collapsible="true" id="srmdetailpageblock5" showHeader="true" title="Date and Time Details">
  <apex:repeat value="{!$ObjectType.BMCServiceDesk__Incident__c.FieldSets.HD_SRM_Date_Time}" var="datetime">
 <apex:pageBlockSectionItem ><apex:outputLabel >{!datetime.Label}</apex:outputLabel> <apex:inputField value="{!mysObject[datetime]}"  required="{!datetime.Required}"/></apex:pageBlockSectionItem>
 </apex:repeat>
 </apex:pageBlockSection>
 
 <apex:pageBlockSection columns="2" collapsible="false" id="srmdetailpageblock6" showHeader="true" title="Assignment Details">
  <apex:repeat value="{!$ObjectType.BMCServiceDesk__Incident__c.FieldSets.HD_SRM_Assignment_detail}" var="assignmentdet">
 <apex:pageBlockSectionItem ><apex:outputLabel >{!assignmentdet.Label}</apex:outputLabel> <apex:inputField value="{!mysObject[assignmentdet]}" required="{!assignmentdet.Required}"/></apex:pageBlockSectionItem>
 </apex:repeat>
 </apex:pageBlockSection>

 </apex:pageBlock> 
 </apex:form>
       
  </apex:tab>

  </apex:tabPanel>
<!--- JAVASCRIPT Section -->
<apex:includeScript value="{!URLFOR($Resource.HDscriptcss,'/jquery-2.1.1.min.js')}" loadOnReady="false"/>
<apex:includeScript value="{!URLFOR($Resource.HDscriptcss,'/bootstrapV3_3_0/js/bootstrap.min.js')}" loadOnReady="false"/>
<apex:includeScript value="{!URLFOR($Resource.HDscriptcss,'/jquery.tablesorter.js')}" loadOnReady="false"/>

<script type="text/javascript">
var $j = jQuery.noConflict();

//popup array
var popups = new Array();


//onload event ontime
$j(document).ready(function(){
$j('[id$=userIdVal_lkwgt]').click(function(){
var current_lookupusr = $j(this).parent('.lookupInput').find('[id$=userIdVal]').val();
openLookup('/apex/hduserlookup?lksrch='+current_lookupusr+'&frm=Srmdetailform&txt=userIdVal', 800, 1, '');
});
});//ready

//popup function
function popitup(url) {
   var newwindow=window.open(url,'name','height=550,width=700');
    popups.push(newwindow);
    if (window.focus) {newwindow.focus()}
    return false;
}//

//popup function
function variable_popitup(url,height,width) {
    var newwindow=window.open(url,'name','height='+height,'width='+width);
        popups.push(newwindow);
    if (window.focus) {newwindow.focus()}
    return false;
}//


//popup function for custom popup
  function openLookup( baseURL, width, modified, searchParam ){
    console.log('Calling OpenLookup()');
    var originalbaseURL = baseURL;
    var originalwidth = width;
    var originalmodified = modified;
    var originalsearchParam = searchParam;
    
    var lookupType = baseURL.substr(baseURL.length-3, 3);
    if (modified == '1') baseURL = baseURL + searchParam;
    
    var isCustomLookup = false;
    
    // Following "001" is the lookup type for Account object so change this as per your standard or custom object
    if(lookupType == "001"){
  
      var urlArr = baseURL.split("&");
      var txtId = '';
      if(urlArr.length > 2) {
        urlArr = urlArr[1].split('=');
        txtId = urlArr[1];
      }
      
      // Following is the url of Custom Lookup page. You need to change that accordingly
      baseURL = "/apex/hduserlookup?txt=" + txtId;
      
      // Following is the id of apex:form control "Srmdetailform". You need to change that accordingly
      baseURL = baseURL + "&frm=" + escapeUTF("{!$Component.Srmdetailform}");
      if (modified == '1') {
        baseURL = baseURL + "&lksearch=" + searchParam;
      }
      
      // Following is the ID of inputField that is the lookup to be customized as custom lookup
      if(txtId.indexOf('userIdVal') > -1 ){
        isCustomLookup = true;
      }
    }
    
    
    if(isCustomLookup == true){
      openPopup(baseURL, "lookup", 350, 480, "width="+width+",height=480,toolbar=no,status=no,directories=no,menubar=no,resizable=yes,scrollable=no", true);
    }
    else {
      if (modified == '1') originalbaseURL = originalbaseURL + originalsearchParam;
      openPopup(originalbaseURL, "lookup", 350, 480, "width="+originalwidth+",height=480,toolbar=no,status=no,directories=no,menubar=no,resizable=yes,scrollable=no", true);
    }     
    
  }//

//Javascriot function for popup
   function popitup(url,height,width) {
   console.log('popitup function called !');
   //newwindow=window.open(url,'name','height='+height+',width='+width);
    newwindow=window.open(url,'name','height=750,width=800,scrollbars=1');
    if (window.focus) {newwindow.focus()}
    return false;
}//

//
function openservicerequest(srmid,reqdefid,clientid)
{
var name = '#00000';
var CLIENTID = clientid;
var REQDEFID = reqdefid;
var SRMID = srmid;
console.log(CLIENTID+' --> '+REQDEFID+" ---> length --> "+SRMID.length);
//alert($j('#newtab a', window.parent.document).text());
//$j('#newtab a', window.parent.document).html( name+'&nbsp;<span id="'+name+'sp" class="glyphicon glyphicon-remove close-glyphicon" title="Close"></span>' );

if( SRMID.length != 0 )
{
//popitup('/apex/BMCServiceDesk__ServiceRequestDetail?incidentId='+SRMID+'&isLookup=true&reqDefId='+REQDEFID+'&reqDtlsId=&clientId='+CLIENTID+'&standardLayout=true&isConsole=true&RequestDetailCloneId=',800,860);
popitup('/apex/ServiceRequestcreatepopup?incidentId='+SRMID+'&reqDefId='+REQDEFID+'&clientId='+CLIENTID+'&refreshUrl=%2Fapex%2FServiceRequestcreate',800,860);
//setTimeout(function(){Redirect('/apex/ServiceRequestcreate?id='+SRMID);},10000);
}//if
return false;
}//

//function to redirect
function Redirect(url)
{
console.log('Redirecting ....');
 window.location.href=url;
}//

function closepopup()
{
console.log('---> Close popup called !');
if(popups.length == 0) return false; 
 for(i=0; i<popups.length; i++) 
    {
        popups[i].close(); 
    }

}//

</script>
</apex:page>