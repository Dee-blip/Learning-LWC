<!-- 
Author: Sharath Prasanna
Created Date: Feb 20 2018
Description: This is the Delegation Approval Custom page
Ticket: FFPSA-142
 -->
<apex:page showHeader="true" id="PSA_DelegatedApproval" sidebar="true"  standardStylesheets="true" controller="PSA_DelegatedApproverController" lightningStylesheets="true">

   <apex:slds />

   <apex:includeScript value="{!$Resource.JQuery_New}"/>  
    
   <script type="text/javascript">
      
         $ = jQuery.noConflict(); 
         $(document).ready(function () {
             
         }); 

        function showMessage(text1)
        {
            hideSpinner();
                $('#MessagePTag').text(text1);
                $('#messages').css('display','block');
                //$('#messages').modal('show');

        }

        function closeMessage()
        {
            $('#messages').css('display','none');
            //$('#messages').modal('hide');
        }

        function showSpinner()
        {
              $('#status').css('display','block');
              //$('#status').modal('show');

        }
        function hideSpinner()
        {
            $('#status').css('display','none');
            //$('#status').modal('hide');
          
        }

        function callSave()
        {   
          $("[id$='errorMessage']").hide();
          var delegationApprover = $("[id$='DelegatedApprover']").val();
          var delegationEndDate = $("[id$='Delegation_EndTime__c']").val();
          if((delegationApprover === undefined ||  delegationApprover === '')&& (delegationEndDate != undefined && delegationEndDate != ''))
          {
            showMessage('Please select the delegation approver before selecting the end date');
          }
          else if(delegationApprover != undefined && delegationApprover != '' && (delegationEndDate === undefined || delegationEndDate === ''))     
          {
            showMessage('Please select the end date!');
          }
          else
          { 
            showSpinner();              
            saveApprover();
          }
          return false;  
        }

        function checkChange()
        {         
          $("[id$='errorMessage']").hide();
          var delegationApprover = $("[id$='DelegatedApprover']").val();
          
          var delegationEndDate = $("[id$='Delegation_EndTime__c']").val();         
          if((delegationApprover === undefined || delegationApprover === '') && (delegationEndDate === undefined || delegationEndDate === ''))
          {

            $('.requiredClass').hide();   
          }
          else
          {
            $('.requiredClass').show(); 
          }

        }
        
        function afterCheckFunction()
        {
          hideSpinner();
          $("[id$='errorMessage']").show();
          // messageString = $('#messageHidden').val();
          // if(messageString === '' || messageString === undefined)
          // {
          //  showMessage('Invalid User!'); 
          // }
          // else
          // {
          //  showMessage(messageString); 
          // }
          // $('#messageHidden').val('');
          // messageString = '';
          
        }

    </script>     

    <div id="messages" style="display: none" class="slds-modal slds-modal--small slds-fade-in-open" onclick="closeMessage();">
      <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true" aria-describedby="modal-content-id-1" class="slds-modal slds-fade-in-open">
        <div class="slds-modal__container">
          <header class="slds-modal__header">
            <h2 id="modal-heading-01" class="slds-text-heading_medium slds-hyphenate">Error!</h2>
          </header>
          <div class="slds-modal__content slds-p-around_medium" id="modal-content-id-1">
                <p id="MessagePTag" > Success!!!</p>
          </div>
          <footer class="slds-modal__footer">
            <button class="slds-button slds-button_neutral" onclick="closeMessage();">Cancel</button>
          </footer>          
        </div>
      </section>
      <div class="slds-backdrop slds-backdrop_open"></div>
    </div>

    <div  id="status" style="display: none;width: 100%;height: 100%" class="slds-scope slds-spinner_container" >
       <div role="status" class="slds-spinner slds-spinner--medium slds-spinner--brand"  >
          <span class="slds-assistive-text">Loading</span>
          <div class="slds-spinner__dot-a"></div>
          <div class="slds-spinner__dot-b"></div>
        </div>
 
    </div>

    <div id="DelegationFormParent">  

        <apex:outputPanel id="errorMessage" styleClass="slds-align_absolute-center">
            <apex:pageMessages id="pmessage" />
        </apex:outputPanel>
        <apex:form id="DelegationForm" >  
  
            <apex:actionFunction name="saveApprover" action="{! saveApprover}" immediate="false" oncomplete="afterCheckFunction();" reRender="messageHiddenPanel,errorMessage"/>

            <apex:outputPanel id="messageHiddenPanel">
                <input id="messageHidden" type="text" value="{! messageString}" style="display: none"/>
            </apex:outputPanel>

            <apex:pageBlock >
                <apex:pageBlockSection columns="1" id="titleSection" title="Delegated Approver" collapsible="false">
                    <apex:pageBlockSectionItem >
                            <apex:outputLabel for="DelegatedApprover" value="Delegated Approver"/>
                            <apex:outputPanel >
                                <div class="requiredInput">
                                    <div class="requiredBlock"></div>                        
                                    <apex:inputField id="DelegatedApprover" value="{! loggedInUser.DelegatedApproverid}" onchange="checkChange();"/>
                                </div>    
                            </apex:outputPanel>    
                    </apex:pageBlockSectionItem>
                    <apex:pageBlockSectionItem >                            
                            <apex:outputLabel for="Delegation_EndTime__c" value="Delegation Expiry"/>
                            <apex:outputPanel >
                                <div class="requiredInput">
                                    <div class="requiredBlock"></div>                                                
                                    <apex:inputField id="Delegation_EndTime__c" value="{! loggedInUser.Delegation_EndTime__c}" onchange="checkChange();"/>
                                </div>
                            </apex:outputPanel>
                    </apex:pageBlockSectionItem>
                </apex:pageBlockSection>    
                <apex:pageBlockButtons location="bottom" style="left: 40% !important">
                    <button type="button" clas="btn btn-primary" onclick="callSave();">Save</button>
                </apex:pageBlockButtons>   
            </apex:pageBlock> 
        </apex:form>   
    </div>


</apex:page>