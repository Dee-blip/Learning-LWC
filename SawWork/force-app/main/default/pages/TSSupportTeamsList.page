<apex:page id="teamListPage" standardController="TS_Support_Team__c" extensions="TSSupportTeamListExtension" recordSetVar="newteams" sidebar="false" standardStylesheets="true" showHeader="false">
    <apex:includeScript value="/support/console/32.0/integration.js"/>
    <head>
        <apex:includeScript value="{!URLFOR($Resource.JQuery111, 'jquery-1.11.2/dist/jquery.min.js')}"/>
        <apex:includeScript value="{!URLFOR($Resource.JQueryUI111, 'jquery-ui.min.js')}"/>
        
        <apex:includeScript value="{!URLFOR($Resource.bootstrap3, 'dist/js/bootstrap.js')}"/>
        <apex:includeScript value="{!URLFOR($Resource.bootstrap3, 'dist/js/bootstrap.min.js')}"/>
        
        <apex:stylesheet value="{!URLFOR($Resource.bootstrap3, 'dist/css/bootstrap.css')}"/>
        <apex:stylesheet value="{!URLFOR($Resource.bootstrap3, 'dist/css/bootstrap.min.css')}"/>
        <script type="text/javascript" src="https://cdn.datatables.net/1.10.8/js/jquery.dataTables.min.js"></script>
        
        
        <apex:stylesheet value="{!URLFOR($Resource.jQueryDataTablesZip, 'jQueryDataTables/css/jquery.dataTables.css')}"/>
        
         <style type="text/css">            
        
            .sorting {
                background: #f2f3f3 url('{!URLFOR($Resource.jQueryDataTablesZip, 'jQueryDataTables/images/sort_both.png') }') no-repeat center right !important;
                padding-right: 20px !important;
            }
            .sorting_asc {
                background: #f2f3f3 url('{!URLFOR($Resource.jQueryDataTablesZip, 'jQueryDataTables/images/sort_asc.png') }') no-repeat center right !important;
                padding-right: 20px !important;
            }
            .sorting_desc {
                background: #f2f3f3 url('{!URLFOR($Resource.jQueryDataTablesZip, 'jQueryDataTables/images/sort_desc.png') }') no-repeat center right !important;
                padding-right: 20px !important;
            }
            .sorting_asc_disabled {
                background: #f2f3f3 url('{!URLFOR($Resource.jQueryDataTablesZip, 'jQueryDataTables/images/sort_asc_disabled.png') }') no-repeat center right !important;
                padding-right: 20px !important;
            }
            .sorting_desc_disabled {
                background: #f2f3f3 url('{!URLFOR($Resource.jQueryDataTablesZip, 'jQueryDataTables/images/sort_desc_disabled.png') }') no-repeat center right !important;
                padding-right: 20px !important;
            }
            table.dataTable tr.odd { background-color: white; }
            table.dataTable tr.even { background-color: white; }
            table.dataTable tr.odd td.sorting_1 { background-color: white; }
            table.dataTable tr.odd td.sorting_2 { background-color: white; }
            table.dataTable tr.odd td.sorting_3 { background-color: white; }
            table.dataTable tr.even td.sorting_1 { background-color: white; }
            table.dataTable tr.even td.sorting_2 { background-color: white; }
            table.dataTable tr.even td.sorting_3 { background-color: white; }
            .dataTables_length, .dataTables_filter, .dataTables_info, .dataTables_paginate {
                padding: 3px;
            }
        </style>    
        <style>
           .colstyle {width:50%;}
           .textsize {font-size: 8.5pt;}
           .ui-state-active {background-color: #87CEFA;}
           .col-height {height: auto}
           .acc-text-primary {display:block; width:100px; color:#428bca}    
           table.dataTable tbody th, table.dataTable tbody td {
                    padding: 8px 10px 0px 6px;
           }
        </style>   
        <script type="text/javascript">
            $( document ).ready(function() {
                console.log('document ready');
                $("#teamListPage\\:form\\:teamDetails\\:teamTable\\:tb tr:eq(0) ").click();                
                $("#teamListPage\\:form\\:teamDetails\\:teamTable\\:0\\:teamName").click();
             });
        
            function confirmDelete(){
                if(confirm('Are you sure you want to delete?'))
                    return true;
                return false;  
            }
            
            function dummyAlert(){
                alert("Hello");
                return false;
            }
            
            function openEditTeamPopup(teamId){
                //var table = $('#teamListPage\\:form\\:teamDetails\\:teamTable').DataTable();
                //table.destroy();
            
                //$('#teamListPage\\:form\\:teamDetails\\:teamTable').dataTable({
                  //  "bSort": false
                // });
                                                
                var editPopup = window.open('/apex/TSSupportTeamCreate?id='+teamId, '_blank','height=400,width=800,left=100,top=100,scrollbars=yes,toolbar=no,status=no');
            }
            
            function openNewMemberPopup(){
                var teamId = document.getElementById('{!$Component.form.paramTeam}').value;
                var teamName = document.getElementById('{!$Component.form.paramName}').value;
                var new_window = window.open("/apex/TSTeamMemberCreate?teamid="+teamId+"&act=New",
'_blank','height=400,width=1000,left=100,top=100,scrollbars=yes,toolbar=no,status=no');
                
                new_window.onbeforeunload = function(){getTeamMembersAndAccounts(teamId, teamName);}
            }

            function openNewAccountPopup(){
                var teamId = document.getElementById('{!$Component.form.paramTeam}').value;
                var teamName = document.getElementById('{!$Component.form.paramName}').value;
                var new_window = window.open("/apex/TSTeamAccountCreate?teamid="+teamId,
'_blank','height=400,width=1000,left=100,top=100,scrollbars=yes,toolbar=no,status=no');
                
                new_window.onbeforeunload = function(){getTeamMembersAndAccounts(teamId, teamName);}
            }
            
            function openEditMemberPopup(userId){
                var teamId = document.getElementById('{!$Component.form.paramTeam}').value;
                var teamName = document.getElementById('{!$Component.form.paramName}').value;
                var new_window = window.open("/apex/TSTeamMemberCreate?id="+userId+"&act=Edit",
                                '_blank','height=400,width=1000,left=100,top=100,scrollbars=yes,toolbar=no,status=no');
                
                new_window.onbeforeunload = function(){getTeamMembersAndAccounts(teamId, teamName);}
            }
       

        function openAccTab(teamAccUrl) {
             sforce.console.generateConsoleUrl([teamAccUrl], openConsoleUrl);        
        }
                              
        var openConsoleUrl = function(result){
            sforce.console.openConsoleUrl(null, result.consoleUrl,true,null,null,openSuccess);        
        }
        
        var openSuccess = function(result) {
        //Report whether opening the new tab was successful
        if (result.success == false)
            alert('The corresponding tab is already opened');
        };
                              
       </script> 
       <script> 
          var lastRow;
             function highlight(elem){
                if(lastRow != undefined){
                    lastRow.children[0].style.backgroundColor = 'white';
                    lastRow.style.backgroundColor = 'white';
                  }  
                elem.style.backgroundColor = '#B0E2FF';
                elem.children[0].style.backgroundColor = '#B0E2FF';
                lastRow = elem;
            }
    </script> 
    <script src="/soap/ajax/31.0/connection.js" type="text/javascript"></script>
    <script>
        function deleteTeam(teamId) {                
                try{ 
                    sforce.connection.sessionId = "{!$Api.Session_ID}";
                    var query1 = "SELECT Id,Name from TS_TeamAccount__c where TS_Support_Team__c = '"+teamId+"'"; 
                    var query2 = "SELECT Id,Name from TS_TeamMember__c where TS_Support_Team__c = '"+teamId+"'"; 
                    var result1 = sforce.connection.query(query1); 
                    var records1 = result1.getArray("records");   
                    var result2 = sforce.connection.query(query2); 
                    var records2 = result2.getArray("records");                
                    if(records1.length > 0 || records2.length > 0)
                    { 
                        alert('The support team cannot be deleted. Please remove all Accounts and Team Members before deleting a support team.');
                        return false;
                    }
                    else{ 
                           if(confirm('Are you sure you want to delete?'))
                           {
                               var query = "SELECT Id,Name from TS_Support_Team__c where Id = '"+teamId+"'";
                               var res = sforce.connection.query(query);
                               var rec = res.getArray("records"); 
                               tid = rec[0].Id;
                               var delResult = sforce.connection.deleteIds([tid]);
                               window.location.reload();
                           }
                           else
                           {
                                return false;
                           } 
                    } 
                } 
                catch(e){ 
                    alert('An Error has Occured. Error:' +e); 
                    return false;
                }
            }
        </script>
        
    </head>
    
    <body class="textsize">
        <div class="container-fluid" id="mainContaniner">
        <apex:form id="form">
            <apex:actionFunction name="getTeamMembersAndAccounts" action="{!getTeamMembersAndAccounts}" rerender="members,accounts,paramTeam,paramName" oncomplete="bringBackSorter();">
                <apex:param name="teamId" value="" assignTo="{!teamId}"/>
                <apex:param name="teamName" value="" assignTo="{!teamName}"/>
            </apex:actionFunction>
            <apex:actionFunction name="refresh" action="{!refresh}" />
            
            <apex:pageBlock id="teamDetails">
                <apex:panelGrid columns="2" style="margin-left:auto; margin-right:auto"> 
                    <apex:commandButton value="Create New Team" rerender="none" onClick="window.open('/apex/TSSupportTeamCreate', '_blank','height=400,width=800,left=100,top=100,scrollbars=yes,toolbar=no,status=no');" rendered="{!IF($Profile.Name =='System Administrator'||$Profile.Name =='Support - Tech Support Manager'||$Profile.Name =='Support - Tech Support Manager with Customer Notification', true , false)}" reRender="none" styleClass="btn btn-default"/>                            
                    <apex:commandButton value="Refresh" styleClass="btn btn-default" onClick="refresh();" reRender="teamDetails"/>
                 </apex:panelGrid>
                <!--<apex:outputPanel style="overflow:scroll;height:350px;" layout="block">-->
                <span style="cursor:pointer;">             
                    <apex:pageBlockTable id="teamTable" value="{!teams}" var="t" styleClass="dataTable teamsdataTable" onRowClick="highlight(this);">   
                        <apex:column headerValue="Action" rendered="{!IF($Profile.Name =='System Administrator'||$Profile.Name =='Support - Tech Support Manager'||$Profile.Name =='Support - Tech Support Manager with Customer Notification', true , false)}">                            
                            <div id="tb_{!t.Id}" class="col-height">
                                <apex:outputLink onclick="openEditTeamPopup('{!t.id}'); return false;">                                   
                                    <apex:outputText value="Edit Team" styleClass="text-primary"/>
                                </apex:outputLink>&nbsp;|&nbsp;
                               <apex:commandLink styleClass="text-primary" onclick="return deleteTeam('{!t.id}'); refresh();" oncomplete="bringBackSorter();" reRender="teamDetails">                                       
                                    <apex:outputText value="Delete" styleClass="text-primary"/>  
                                </apex:commandLink>
                            </div>
                        </apex:column>
                        <apex:column headerValue="Support Team Name" id="teamName"  onclick="getTeamMembersAndAccounts('{!t.Id}','{!t.Team_Name__c}');">
                            <div class="col-height">
                            <apex:outputField value="{!t.Team_Name__c}"/> </div>
                        </apex:column>
                        <apex:column headerValue="Team Type" onclick="getTeamMembersAndAccounts('{!t.Id}','{!t.Team_Name__c}');return false;">
                            <div class="col-height">{!t.Team_Type__c}</div>
                        </apex:column>
                        <apex:column headerValue="VDN" onclick="getTeamMembersAndAccounts('{!t.Id}','{!t.Team_Name__c}');">
                            <div class="col-height">{!t.VDN__c}</div>
                        </apex:column>
                        <apex:column headerValue="Last Modified By" onclick="getTeamMembersAndAccounts('{!t.Id}','{!t.Team_Name__c}');">
                            <div class="col-height">{!t.LastModifiedBy.Name}</div>
                        </apex:column>
                        <apex:column headerValue="Last Modified Date" onclick="getTeamMembersAndAccounts('{!t.Id}','{!t.Team_Name__c}');">
                            <div class="col-height">
                                <apex:outputText value="{0, date, MM/dd/yyyy hh:mm:ss a z }">
                                    <apex:param value="{!t.LastModifiedDate}" /> 
                                </apex:outputText>
                            </div>
                        </apex:column>  
                        <apex:column headerValue="Row ID" onclick="getTeamMembersAndAccounts('{!t.Id}','{!t.Team_Name__c}');">
                            <div class="col-height">{!t.Akam_Row_ID__c}</div>
                        </apex:column>  
                        <apex:column headerValue="#Accounts" onclick="getTeamMembersAndAccounts('{!t.Id}','{!t.Team_Name__c}');">
                            <div class="col-height">{!teamAccountMap[t.Id]}</div>
                        </apex:column>                            
                    </apex:pageBlockTable> 
                    </span>
                <!--</apex:outputPanel>-->
            </apex:pageBlock>   
            
            <apex:inputHidden id="paramTeam" value="{!teamId}"/>
            <apex:inputHidden id="paramName" value="{!teamName}"/>            
            
            <apex:panelGrid columns="2" style="margin-left:auto; margin-right:auto;" id="memacc" width="100%" columnClasses="colstyle">
                <apex:outputPanel id="membersOutputPanel">
                <apex:pageblock id="members" title="Team Members: {!teamName}">
                    <apex:panelGrid columns="1" style="margin-left:auto; margin-right:auto"> 
                        <apex:commandButton value="New Team Member" onClick="openNewMemberPopup();" rendered="{!IF($Profile.Name =='System Administrator'||$Profile.Name =='Support - Tech Support Manager'||$Profile.Name =='Support - Tech Support Manager with Customer Notification', true , false)}" reRender="none" styleClass="btn btn-default" disabled="{!teamId==null}"/>                            
                        <!--apex:commandButton value="Refresh" styleClass="btn btn-default" onClick="teamMemberRefresh(); return false;" disabled="{!teamId==null}"/-->
                    </apex:panelGrid>
                    <apex:outputPanel style="overflow:scroll;height:250px;" layout="block">
                        <apex:pageBlockTable value="{!userList}" var="u" styleClass="table membersdataTable">
                            <apex:column headerValue="Action" rendered="{!IF($Profile.Name =='System Administrator'||$Profile.Name =='Support - Tech Support Manager'||$Profile.Name =='Support - Tech Support Manager with Customer Notification', true , false)}">
                                <div class="col-height">
                                    <apex:outputLink onclick="openEditMemberPopup('{!u.Id}'); return false;">
                                        <apex:outputText value="Edit" styleClass="text-primary"/>
                                    </apex:outputLink>&nbsp;|&nbsp;
                                    <!--apex:outputLink value="{!URLFOR($Action.TS_TeamMember__c.Delete,u.Id,[retURL='/apex/TSSupportTeamsList'])}" onclick="return confirmDelete();">
                                        <apex:outputText value="Delete" styleClass="text-primary" />    
                                    </apex:outputLink--> 
                                    <apex:commandLink action="{!deleteMember}" styleClass="text-primary" onclick="if(!confirm('Are you sure?')) return false;" rerender="members" oncomplete="bringBackSorter();">                                       
                                        <apex:outputText value="Delete" styleClass="text-primary"/>
                                        <apex:param value="{!u.Id}" name="idToDel" assignTo="{!toBeDelMember}"/>
                                    </apex:commandLink>
                                </div>
                            </apex:column>
                            <apex:column headerValue="Login">
                                <div class="col-height">{!u.Team_Member__r.alias}</div>
                            </apex:column>
                            <apex:column headerValue="First Name">
                                 <div class="col-height">{!u.Team_Member__r.FirstName}</div>
                             </apex:column>
                            <apex:column headerValue="Last Name">
                                <div class="col-height">{!u.Team_Member__r.LastName}</div>
                            </apex:column>
                            <apex:column headerValue="Role Type">
                                <div class="col-height">{!u.Role__c}</div>
                            </apex:column>                      
                        </apex:pageBlockTable>
                    </apex:outputPanel>
                </apex:pageblock>
                </apex:outputPanel>
               <apex:outputPanel >
                <apex:pageblock id="accounts" title="Team Accounts: {!teamName}">
                    <apex:panelGrid columns="1" style="margin-left:auto; margin-right:auto"> 
                        <apex:commandButton value="New Team Account" onClick="openNewAccountPopup();" rendered="{!IF($Profile.Name =='System Administrator'||$Profile.Name =='Support - Tech Support Manager'||$Profile.Name =='Support - Tech Support Manager with Customer Notification', true , false)}" reRender="none" styleClass="btn btn-default" disabled="{!teamId==null}"/>                            
                        <!--apex:commandButton value="Refresh" styleClass="btn btn-default" onClick="teamAccountRefresh(); return false;" disabled="{!teamId==null}"/-->
                    </apex:panelGrid>
                    <apex:outputPanel style="overflow:scroll;height:250px;" layout="block">
                        <apex:pageBlockTable value="{!accountList}" id="accountsPList" var="a" styleClass="table accsdataTable">
                            <apex:column headerValue="Action" rendered="{!IF($Profile.Name =='System Administrator'||$Profile.Name =='Support - Tech Support Manager'||$Profile.Name =='Support - Tech Support Manager with Customer Notification', true , false)}">
                                <div class="col-height">
                                    <!--apex:outputLink value="{!URLFOR($Action.TS_TeamAccount__c.Delete,a.Id,[retURL='/apex/TSSupportTeamsList'])}" onclick="return confirmDelete()">
                                        <apex:outputText value="Delete" styleClass="text-primary"/>    
                                    </apex:outputLink-->
                                    <apex:commandLink action="{!deleteAcc}" onclick="if(!confirm('Are you sure?')) return false;" rerender="accounts" styleClass="text-primary" oncomplete="bringBackSorter();">
                                        <apex:outputText value="Delete" styleClass="text-primary"/>
                                        <apex:param value="{!a.Id}" name="accidToDel" assignTo="{!toBeDelAcc}"/>
                                    </apex:commandLink>
                                </div>
                            </apex:column>                            
                            <apex:column headerValue="Account Name">
                                <div class="col-height">
                                    <apex:outputLink target="_blank" onclick="openAccTab('/{!a.Team_Account__r.Id}');return false" >
                                        <apex:outputText value="{!a.Team_Account__r.Name}" styleClass="acc-text-primary"/>    
                                    </apex:outputLink> 
                                </div>
                            </apex:column>
                            <apex:column headerValue="ERC">
                                <div class="col-height">{!a.Team_Account__r.ERC_Numeric__c}</div>
                            </apex:column>
                            <apex:column headerValue="Account Id" style="width :100%">
                                <div class="col-height">{!a.Team_Account__r.AKAM_Account_ID__c}</div>
                            </apex:column>
                            <apex:column headerValue="Support Level">
                                <div class="col-height">{!a.Team_Account__r.Support_Level__c}</div>
                            </apex:column>
                            <apex:column headerValue="Customer Tier">
                                <div class="col-height">{!a.Team_Account__r.Customer_Tier__c}</div>
                            </apex:column>
                            <apex:column headerValue="Geography">
                                <div class="col-height">{!a.Team_Account__r.Geography_Formula__c}</div>
                            </apex:column>                           
                        </apex:pageBlockTable>
                    </apex:outputPanel>
                </apex:pageblock>
               </apex:outputPanel>
            </apex:panelGrid>
        </apex:form>        
        </div>   <!-- end of container-->
    </body>
    <script type="text/javascript" language="javascript" src="{!URLFOR($Resource.jQueryDataTablesZip, 'jQueryDataTables/js/jquery.js')}"></script>
    <script type="text/javascript" language="javascript" src="{!URLFOR($Resource.jQueryDataTablesZip, 'jQueryDataTables/js/jquery.dataTables.js')}"></script>
    <script type="text/javascript" language="javascript">
    var j$ = jQuery.noConflict();
    
    j$('table.dataTable').dataTable({
        aaSorting: [],
        "sPaginationType": "full_numbers"
    });
    
    function bringBackSorter(){
 
       j$('table.membersdataTable').dataTable({
            //"sPaginationType": false,
            "paginate": false,
            "filter": false,
            "language": {
                "info": "",
                "infoEmpty": ""
             },
            "bredraw":true,
           "bDestroy": true
       });
       j$('table.accsdataTable').dataTable({
        //"sPaginationType": "full_numbers",
            "paginate": false,
            "filter": false,
            "language": {
                "info": "",
                "infoEmpty": ""
             },
            "bredraw":true,
           "bDestroy": true
        });
    }    
    </script>
</apex:page>