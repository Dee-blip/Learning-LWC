<apex:page standardController="Account" extensions="TSAccountERCExtension" sidebar="false" standardStylesheets="true" showHeader="false">
    <head>
        <apex:includeScript value="{!URLFOR($Resource.JQuery111, 'jquery-1.11.2/dist/jquery.min.js')}"/>
        <apex:includeScript value="{!URLFOR($Resource.JQueryUI111, 'jquery-ui.min.js')}"/>

        <apex:includeScript value="{!URLFOR($Resource.bootstrap3, 'dist/js/bootstrap.js')}"/>
        <apex:includeScript value="{!URLFOR($Resource.bootstrap3, 'dist/js/bootstrap.min.js')}"/>

        <apex:stylesheet value="{!URLFOR($Resource.bootstrap3, 'dist/css/bootstrap.css')}"/>
        <apex:stylesheet value="{!URLFOR($Resource.bootstrap3, 'dist/css/bootstrap.min.css')}"/>

        <apex:stylesheet value="{!URLFOR($Resource.jQueryDataTablesZip, 'jQueryDataTables/css/jquery.dataTables.css')}"/>
        <script language="JavaScript" type="text/javascript">
            function CloseAndRefresh(){
            window.opener.location.href="/{!$CurrentPage.parameters.id}";
                  window.top.close();

          }
        </script>

        <script type="text/javascript">
            function closeWin(){
                var successElement = document.getElementById('{!$Component.form.success}');
                if(successElement.value=='true')
                {
                    if(window.parent){
                        window.parent.opener.location.href = window.parent.opener.location.href;
                        window.parent.close();
                    }
                    else{
                        window.opener.location.href = window.opener.location.href;
                        window.close();
                    }
                }
            }

        </script>

        <apex:outputPanel id="jsFunctions">
        <script src="/soap/ajax/31.0/connection.js" type="text/javascript"></script>
        <script>
            var ercNum = '';
            // check for accounts with same ERC numeric and display warning message to users
            function checkForAccountsWithSameERCs()
            {
                try{
                    ercVar = document.getElementById('{!$Component.form.pageblock.pbs.pbsi.ErcField}').value;
                    if(ercVar != '') {
                        fetchErcNumeric(ercVar);
                        ercNum = "{!JSENCODE(ercNumeric)}";
                    }
                    else {
                        saveERC();
                    }

                }
                catch(e){
                    alert('An Error has Occured. Error:' +e);
                    return false;
                }
            }

            function getAccounts()
            {
                try{
                    var accString = '';
                    ercNum = "{!JSENCODE(ercNumeric)}";
                    if(ercNum != '') {
                        var accId = "{!JSENCODE(accObj.id)}";
                        sforce.connection.sessionId = "{!$Api.Session_ID}";
                        var query = "Select Id, Name, ERC_Numeric__c from Account where ERC_Numeric__c ='"+ercNum+"' and Id !='"+accId+"'";
                        var result = sforce.connection.query(query);
                        var records = result.getArray("records");
                        for(var i=0; i < records.length; i++) {
                            if(i > 0) accString += ',';
                            accString += records[i].Name;
                        }
                        if(records.length > 0) {
                            var query2 = "SELECT TS_Support_Team__c, Team_Account__c from TS_TeamAccount__c where Team_Account__c ='"+records[0].Id+"'";
                            var result2 = sforce.connection.query(query2);
                            var records2 = result2.getArray("records");
                            var query3 = "SELECT TS_Support_Team__c, Team_Account__c from TS_TeamAccount__c where Team_Account__c ='"+accId+"'";
                            var result3 = sforce.connection.query(query3);
                            var records3 = result3.getArray("records");
                            if(records2.length > 0 && records3.length > 0)
                            {
                                if(records2[0].TS_Support_Team__c != records3[0].TS_Support_Team__c) {
                                    alert("Accounts that share an ERC must be assigned to the same support team");
                                    return false;
                                }
                                else {
                                    displayERCWarning(accString);
                                }
                            }
                            else {
                                displayERCWarning(accString);
                            }
                        }
                        else {
                            saveERC();
                        }
                    }                    
                }
                catch(e){
                    alert('An Error has Occured. Error:' +e);
                    return false;
                }
            }
            
            function displayERCWarning(accString) {
                if(confirm('The ERC entered is already assigned to the following Accounts:' +accString+ '.Do you wish to proceed?')) {
                    saveERC();
                }
                else {
                    return false;
                }
            }

        </script>
        </apex:outputPanel>

        <style>
           .textsize {font-size: 9pt;}
        </style>
    </head>
    <body class="textsize">
        <div class="container-fluid">
            <apex:form id="form">
                <apex:pageMessages id="msgQ"/>
                <apex:inputHidden id="success" value="{!success}"/><br/>
                <apex:inputHidden id="ercNumericVar" value="{!ercNumeric}"/><br/>
                <apex:actionFunction name="fetchErcNumeric" action="{!fetchErcNumeric}" oncomplete="getAccounts();" rerender="jsFunctions">
                    <apex:param name="currErc" value=""/>
                </apex:actionFunction>
                <apex:actionFunction name="saveERC" action="{!save}" oncomplete="closeWin();" rerender="success,ercEnteredVar"/>
                <apex:pageBlock id="pageblock">
                    <apex:pageBlockSection columns="1" title="Account ERC" collapsible="false" id="pbs">
                        <apex:pageblockSectionItem >
                            <apex:outputLabel >Account Name</apex:outputLabel>
                            <apex:outputText value="{!Account.Name}"/>
                        </apex:pageblockSectionItem>
                        <apex:pageblockSectionItem id="pbsi">
                            <apex:outputLabel >AKERC</apex:outputLabel>
                            <apex:InputText id="ErcField" value="{!ercEntered}"/>
                        </apex:pageblockSectionItem>
                    </apex:pageBlockSection>
                </apex:pageBlock>
                <apex:panelGrid columns="2" style="margin-left:auto; margin-right:auto">
                    <apex:commandButton value="Save" onClick="return checkForAccountsWithSameERCs();" styleClass="btn btn-default" rerender="success,msgQ,accNamesVar"/>
                    <apex:commandButton value="Cancel" onClick="window.close();"  styleClass="btn btn-default" immediate="true"/>
                </apex:panelGrid>
            </apex:form>
        </div>
    </body>
</apex:page>