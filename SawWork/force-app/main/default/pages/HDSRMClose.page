<!-- 
Modification Log
===============================================================
Date Author Modification
Line 57,59 12 Aug 2020, Amogh M P, PRTORES-1812 HD Code scan 2020 - Blockers, Criticals Part 6
--> 
<apex:page standardController="BMCServiceDesk__Incident__c" showheader="false" id="srmclosepg" extensions="HD_Closepopup">
<apex:pageMessages id="msgbox"></apex:pageMessages>
<apex:form id="srmclosepgform">
<apex:pageBlock id="srmclosepgblock">
<apex:pageBlockButtons location="top" id="srmclosepgblockbutton">
<apex:actionFunction action="{!ajaxSave}" status="statusaction" name="ajaxSave" reRender="out,msgbox,errorflagid"   oncomplete="CloseAndRefresh();" />
<apex:commandButton value="save" id="srmclosepgblockbuttonsave" onclick="scriptSave();return false;" disabled="{!savebuttonFlag}"/>
<apex:inputHidden value="{!errorFlag}" id="errorflagid"/>
<apex:actionStatus id="statusaction" startText="Busy...."><apex:facet name="start"><img src="{!URLFOR($Resource.HDscriptcss,'ajax-loader.gif')}" width="25"></img></apex:facet></apex:actionStatus>
</apex:pageBlockButtons>
<apex:pageBlockSection collapsible="false" title="Service Request Close :{!BMCServiceDesk__Incident__c.Name}" columns="1" id="srmclosepgblocksection1">
<apex:repeat value="{!$ObjectType.BMCServiceDesk__Incident__c.FieldSets.BMCServiceDesk__CloseFS}" var="cf"> 
       <apex:pageBlockSectionItem id="srmclosepgblocksectionitem1"  rendered="{!IF(cf = ('BMCServiceDesk__closeDateTime__c'),false,true)}">
       <apex:outputLabel value="{!cf.Label}"></apex:outputLabel><apex:inputField value="{!BMCServiceDesk__Incident__c[cf]}" required="{!cf.Required}" id="srmclosepgblocksectionitem1field"/> 
       </apex:pageBlockSectionItem>
       <!-- for ReadOnly Fields -->
        <apex:pageBlockSectionItem id="srmclosepgblocksectionitem1readonly"  rendered="{!IF(cf = ('BMCServiceDesk__closeDateTime__c'),true,false)}">
       <apex:outputLabel value="{!cf.Label}"></apex:outputLabel><apex:OutputField value="{!BMCServiceDesk__Incident__c[cf]}" id="srmclosepgblocksectionitem1fieldreadonly"/> 
       </apex:pageBlockSectionItem>
    </apex:repeat>

</apex:pageBlockSection>

</apex:pageBlock>
</apex:form>
<!--- Calling Salesforce Ajax Library ----->
<script src="/soap/ajax/29.0/connection.js" type="text/javascript"></script>

<script language="JavaScript" type="text/javascript">
var __sfdcSessionId = '{!GETSESSIONID()}';
function scriptSave()
{
try
{
ajaxSave();
}
catch(err)
{
alert('error occured !');
}

}//function scriptSave()


//function to close and refresh parent window
function CloseAndRefresh()
{
var pagevalidation = document.getElementById('{!$Component.msgbox}').innerHTML.indexOf('ERROR') > -1;
//alert('--->'+pagevalidation);
//
var errorFlag = document.getElementById('{!$Component.srmclosepg:srmclosepgform:srmclosepgblock:srmclosepgblockbutton:errorflagid}').value;
try{
if( errorFlag == 'false' && pagevalidation == false)
{
console.log("Exception happened Error Time");
 //redirect and close process
 parent.window.opener.location.href="/apex/ServiceRequestdetail?id={!$CurrentPage.parameters.id}";
 window.parent.location.reload();
 window.close();
}


 }//try
 catch(err)
 {
 alert('Exception[]: '+err);
 }//catch
 return false;
 }//function to close an refresh parent window
 
</script>
</apex:page>