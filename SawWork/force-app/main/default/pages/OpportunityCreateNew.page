<apex:page standardController="Opportunity" extensions="OpportunityCreateNew">
    <apex:includeScript value="{!URLFOR($Resource.Jquery_1_11,'js/jquery-1.11.3.min.js')}"/>
    <apex:includeScript value="/lightning/lightning.out.js" />
    <apex:pageMessages id="msgs" escape="false"/>

    <style>
    .custPopup{
            background-color: white;
            border-width: 2px;
            border-style: solid;
            z-index: 9999;
            left: 50%;
            padding:10px;
            position: absolute;
            /* These are the 3 css properties you will need to change so the popup
            displays in the center of the screen. First set the width. Then set
            margin-left to negative half of what the width is. You can add
            the height property for a fixed size pop up if you want.*/
            width: 1000px;
            margin-left: -400px;
            top:20%;
        }
        .popupBackground{
            background-color:black;
            opacity: 0.20;
            filter: alpha(opacity = 20);
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 9998;
        }
</style>
    <script>

      window.onload = function () {

       if("{! JSENCODE($User.UIThemeDisplayed )}" == "Theme4d") // SFDC-5897 modified to have JSENCODE
      {
            window.parent.location = '/one/one.app#eyJjb21wb25lbnREZWYiIDogImM6U0YxX09wcG9ydHVuaXR5RmxvdyIsImF0dHJpYnV0ZXMiIDoge319';
      }
      }
    </script>
    <script>
    $j = jQuery.noConflict();

    function checkboxChanged(checkbox,toggle,isContractChange) {
      if(!toggle || isContractChange){
             // Get the name of the checkbox which changed
        var changedCheckboxId = $j(checkbox).attr('name');

        // Get all checkboxes
        $j(":checkbox[data-cbType='mainContactCheckbox']").each(function(index) {

            // Set all checkboxes EXCEPT the recently changed one to be unchecked
            if (changedCheckboxId != $j(this).attr('name')) {
                    $j(this).attr('checked', false);
            }
        });

      }

    };
</script>

    <div id="lightning"/>
    <script>

  if ("{! JSENCODE($User.UIThemeDisplayed) }" == "Theme4t") {  // SFDC-5897 modified to have JSENCODE

    $Lightning.use("c:SF1_NewOpportunityMobileApp", function () {
      $Lightning.createComponent("c:SF1_NewOpportunityMobileHomeWrapper", {receivedAccountID: "{!JSENCODE($CurrentPage.parameters.accid)}"}, "lightning", function (cmp) {
        // do some stuff // SFDC-5897 modified to have JSENCODE
      });
    });
  }
</script>

    <apex:form id="form1" rendered="{!noOpenOpps && $User.UIThemeDisplayed  != 'Theme4d' && $User.UIThemeDisplayed  != 'Theme4t'}">


        <apex:outputpanel >
            <apex:actionstatus id="showSpinner">
                <apex:facet name="start">
                    <div class="waitingSearchDiv" id="el_loading" style="background-color: #d3d3d3; height: 100%;opacity:0.60;width:100%;">
                        <div class="waitingHolder" style="top: 74.2px; width: 100px;">
                            <img class="waitingImage" src="/img/loading.gif"  title="Please Wait..." />
                            <span  class="waitingDescription" style="height: 40px; width: 100px; color:darkred;" >Please Wait...</span>
                        </div>
                    </div>
                </apex:facet>
            </apex:actionstatus>
        </apex:outputpanel>

        <apex:pageBlock id="accountSection" title="Search Account">
            <apex:outputPanel id="top" layout="block" style="margin:5px;padding:10px;padding-top:2px;">
                <apex:outputLabel value="Account Name :" style="padding-right:10px;" for="txtSearch"/>
                <apex:inputField value="{!Opportunity.AccountId}" rendered="{!!fromAccount}">
                    <apex:actionSupport event="onchange" action="{!AccountPopulated}" rerender="oppSection,noRecordId,contractSection"/>
                </apex:inputField>
                <apex:outputField value="{!Opportunity.AccountId}" rendered="{!fromAccount}" />
            </apex:outputPanel>
        </apex:pageBlock>
        <apex:pageBlock id="baselineSelectionSection" title="Select Contract Baseline" rendered="{!!isFeatureToggle}">
            <apex:actionRegion >
                <apex:selectRadio value="{!contractBaselineOption}">
                    <apex:actionSupport event="onchange" reRender="Results" action="{!checkOptionValue}" status="showSpinner"/>
                    <apex:selectOptions value="{!contractBaselineOptions}"/>
                </apex:selectRadio>
            </apex:actionRegion>
        </apex:pageBlock>


        <!-- Changed  the message and Remove the Rendered Tag For making the message static  for CR 2902296(Rahul)-->
        <apex:outputPanel id="Results">
            <apex:pageBlock title="Contract Change Type" rendered="{!isContractChange}">
                <apex:selectRadio value="{!contractChangeType}">
                    <apex:actionSupport event="onchange" reRender="Results" action="{!onContractTypeChange}" status="showSpinner"/>
                    <apex:selectOptions value="{!contractChangeOptions}"/>
                </apex:selectRadio>
            </apex:pageBlock>
            <apex:outputPanel rendered="{!showContractSection}">

                <apex:pageBlock id="contractSection" title="Select Contract"  rendered="{!showContractListSection}" >
                    <!--apex:outputPanel style="padding-bottom:10px;padding-top:2px;font-style:italic;" layout="block" >
                       <apex:outputText >Please select contracts of the <b>same currency</b>.</apex:outputText>
                   </apex:outputPanel-->
                    <apex:pageblockTable value="{!ContractWrapper}"  var="contractRecord">
                        <apex:column headerValue="Select">
                            <apex:inputCheckbox value="{!contractRecord.Checkbox}" id="inputId" html-data-cbType="mainContactCheckbox">
                                <apex:actionSupport event="onclick" reRender="ContractResults,msgs" action="{!inputCheckForRenewalOppty}" onSubmit="checkboxChanged(this,{!IF(EMRIMultipleContractsToggle,'true','false')},{!IF(isContractChange,'true','false')})"
                                                    status="showSpinner"> <!-- SFDC-5897 Modified to have IF condition -->
                                </apex:actionSupport>
                            </apex:inputCheckbox>
                        </apex:column>
                        <apex:column value="{!contractRecord.mch.Original_Contract_Id__c}"/>
                        <apex:column value="{!contractRecord.mch.Parent_Contract__c}"/>
                        <apex:column value="{!contractRecord.mch.Order_Id__c}"/>
                        <apex:column value="{!contractRecord.mch.Currency__c}"/>
                        <apex:column value="{!contractRecord.mch.Contract_Type__c}"/>
                        <apex:column value="{!contractRecord.mch.Parent_Account_Name__c }"/>
                        <apex:column value="{!contractRecord.mch.Solution_Set__c}"/>
                        <apex:column value="{!contractRecord.mch.Effective_End_Date__c}"/>
                        <apex:column value="{!contractRecord.mch.Effective_Start_Date__c}"/>
                        <apex:column headerValue="Contract Products" rendered="{!!isContractChange}">
                            <apex:commandButton action="{!showContractProducts}" reRender="contractproductpopup"  value="View
                ({!FLOOR(contractRecord.mch.Contract_Product_Count__c)})" status="showSpinner">
                                <apex:param id="param2" name="tempLineId2" value="{!contractRecord.mch.Original_Contract_Id__c}" assignTo="{!contractIdForProduct}" />
                            </apex:commandButton>
                        </apex:column>


                    </apex:pageblockTable>
                </apex:pageBlock>
                <apex:outputPanel style="padding-bottom:10px;padding-top:2px;font-style:italic;" layout="block" rendered="{!!showContractListSection}" >
                    <apex:outputText >No Contract Records for the Associated Account </apex:outputText>
                </apex:outputPanel>
                <apex:outputPanel id="ContractResults" >
                    <apex:outputText rendered="{!isContractCurrencyMismatch}" style="color:red; font-size: 15px" value="Note: Please select ‘Other Currency’ option to choose the opportunity Currency, as you’ve selected multiple Contracts of different currencies " >
                    </apex:outputText>
                    <!-- Start: SFDC-3550 -->
                    <apex:pageBlock title="Select Opportunity Type" rendered="{!isContractSelected}">
                        <apex:selectList value="{!selectedOpptyType}" id="oppTypeSelectId" size="1">
                            <apex:selectOptions value="{!withBaselineOpptyTypes}" rendered="{!contractBaselineOption == "Create Opportunity With Contract Baseline"}"/>
                            <apex:selectOptions value="{!contractChangeOpptyTypes}" rendered="{!contractBaselineOption == "Create Contract Change Opportunity"}"/>
                        </apex:selectList>
                    </apex:pageBlock>
                    <!-- End: SFDC-3550 -->
                    <apex:pageBlock title="Choose Currency For New Opportunity" rendered="{!isContractSelected}">
                        <apex:pageBlockSection >
                            <apex:pageBlockSectionItem dataStyle="width: 20%" >
                                <apex:selectRadio value="{!selectedcurrencyOption}" required="true">
                                    <apex:selectOptions value="{!currencyOptions}"/>
                                    <apex:actionSupport event="onclick" reRender="CreateOpptyButton,msgs" action="{!inputCheckForRenewalOppty}"  status="showSpinner"/>

                                </apex:selectRadio>
                            </apex:pageBlockSectionItem>
                            <apex:pageBlockSectionItem dataStyle="width: 62%;padding-top:10px" rendered="{!!isContractChange}">
                                <apex:selectList id="isocodesid" size="1" value="{!selectedCurrency}" >

                                    <apex:selectOptions value="{!Currencies}"></apex:selectOptions>
                                    <apex:actionSupport event="onchange" reRender="CreateOpptyButton,msgs" action="{!inputCheckForRenewalOppty}"  status="showSpinner"/>
                                </apex:selectList>

                            </apex:pageBlockSectionItem>

                        </apex:pageBlockSection>

                    </apex:pageBlock>
                    <apex:outputPanel rendered="{!showOpenRenewalOpptySection && isContractSelected && !isContractChange}">
                        <apex:pageBlock title="Open Opportunities" id="renoppSection" >
                            <apex:outputPanel style="padding-bottom:10px;padding-top:2px;font-style:italic;" layout="block" >
                                <apex:outputText >Below are the open opportunities listed for the selected contract. If you cannot locate your opportunity, click Create Opportunity to create a new one.</apex:outputText>
                            </apex:outputPanel>
                            <apex:pageBlockTable value="{!openRenewalOpps}" var="opp" rendered="{!flagRenewal}">
                                <apex:column >
                                    <apex:facet name="header">
                                        <apex:outputPanel >Name</apex:outputPanel>
                                    </apex:facet>
                                    <apex:outputLink value="{!urlcode}/{!opp.id}">{!opp.name}</apex:outputLink>
                                </apex:column>

                                <apex:column >
                                    <apex:facet name="header">
                                        <apex:outputPanel >Stage</apex:outputPanel>
                                    </apex:facet>
                                    <apex:outputField value="{!opp.StageName}"/>
                                </apex:column>

                                <apex:column >
                                    <apex:facet name="header">
                                        <apex:outputPanel >Close Date</apex:outputPanel>
                                    </apex:facet>
                                    <apex:outputField value="{!opp.CloseDate}"/>
                                </apex:column>

                                <apex:column >
                                    <apex:facet name="header">
                                        <apex:outputPanel >MRR</apex:outputPanel>
                                    </apex:facet>
                                    <apex:OutputText value="{0, number, #,###0.00}">
                                        <apex:Param value="{!opp.MRR__c}" />
                                    </apex:OutputText>
                                </apex:column>

                                <apex:column >
                                    <apex:facet name="header">
                                        <apex:outputPanel >Primary Product Name</apex:outputPanel>
                                    </apex:facet>
                                    <apex:outputField value="{!opp.Primary_Product_Name__c}"/>
                                </apex:column>

                                <apex:column >
                                    <apex:facet name="header">
                                        <apex:outputPanel >Type</apex:outputPanel>
                                    </apex:facet>
                                    <apex:outputField value="{!opp.Opportunity_Type__c}"/>
                                </apex:column>

                                <apex:column headerValue="Associated Contracts">
                                    <apex:commandButton action="{!showContractsAssociatedToOppty}" reRender="associatedcontractpopup"  value="View"
                                                        status="showSpinner">
                                        <apex:param name="opportunityId" value="{!opp.Id}" assignTo="{!opportunityIdForContracts}" />
                                    </apex:commandButton>
                                </apex:column>
                            </apex:pageBlockTable>
                        </apex:pageBlock>
                    </apex:outputPanel>
                    <apex:outputPanel rendered="{!!flagRenewal && isContractSelected && !isContractChange}" id="noRecordId" >
                        <apex:pageMessage severity="ERROR" summary="No renewal Opportunities to display. Select <b>opportunity currency</b> and then click <b>Create Opportunity</b> to create a new  renewal Opportunity. " escape = "false"/>
                    </apex:outputPanel>
                    <div align="center">

                        <apex:outputPanel id="CreateOpptyButton" rendered="{!!isContractChange}">
                            <apex:commandButton value="Create Opportunity" rendered="{!isContractSelected && !isContractCurrencyMismatch}"  action="{!createOpportunity}"  style="float:left;width:120px;height:30px;font-weight:bold;" status="showSpinner" reRender="msgs"/>
                        </apex:outputPanel>

                        <!--apex:commandButton value="Create Opportunity" rendered="{!isContractSelected}"  action="{!createOpportunity}"  style="float:left;width:120px;height:30px;font-weight:bold;" status="showSpinner" reRender="form1,Results,ContractResults,noRecordId,oppSection,sf1tblResults,form2,msgs" /-->
                        <apex:outputPanel id="NextScreenButton" rendered="{!isContractChange}">
                            <apex:commandButton value="Next" rendered="{!isContractSelected && !isContractCurrencyMismatch}" action="{!navigateToNextScreen}" style="float:left;width:120px;height:30px;font-weight:bold;">
                                <apex:actionSupport event="onclick" reRender="Results" status="showSpinner"/>
                            </apex:commandButton>
                        </apex:outputPanel>
                    </div>
                </apex:outputPanel>
            </apex:outputPanel>

            <!-- Start: SFDC-3550 -->
            <apex:outputPanel rendered="{!showOppTypeBlock}">
                <apex:pageBlock title="Select Opportunity Type">
                    <apex:selectList value="{!selectedOpptyType}" id="oppTypeSelectId" size="1">
                        <apex:selectOptions value="{!withoutBaselineOpptyTypes}"/>
                    </apex:selectList>
                </apex:pageBlock>
            </apex:outputPanel>
            <!-- End: SFDC-3550 -->

            <apex:outputPanel rendered="{!showOpenOpptySection}">
                <apex:pageBlock title="Open Opportunities" id="oppSection" >
                    <apex:outputPanel style="padding-bottom:10px;padding-top:2px;font-style:italic;" layout="block" >
                        <apex:outputText >Below are the open opportunities listed for this account. If you cannot locate your opportunity, skip to create a new one.</apex:outputText>
                    </apex:outputPanel>

                    <apex:pageBlockTable value="{!openOpps}" var="o" id="tblResults" rendered="{!flag}">
                        <apex:column >
                            <apex:facet name="header">
                                <apex:outputPanel >Name</apex:outputPanel>
                            </apex:facet>
                            <apex:outputLink value="{!urlcode}/{!o.id}">{!o.name}</apex:outputLink>
                        </apex:column>

                        <apex:column >
                            <apex:facet name="header">
                                <apex:outputPanel >Stage</apex:outputPanel>
                            </apex:facet>
                            <apex:outputField value="{!o.StageName}"/>
                        </apex:column>

                        <apex:column >
                            <apex:facet name="header">
                                <apex:outputPanel >Close Date</apex:outputPanel>
                            </apex:facet>
                            <apex:outputField value="{!o.CloseDate}"/>
                        </apex:column>

                        <apex:column >
                            <apex:facet name="header">
                                <apex:outputPanel >MRR</apex:outputPanel>
                            </apex:facet>
                            <apex:OutputText value="{0, number, #,###0.00}">
                                <apex:Param value="{!o.MRR__c}" />
                            </apex:OutputText>
                        </apex:column>

                        <apex:column >
                            <apex:facet name="header">
                                <apex:outputPanel >Primary Product Name</apex:outputPanel>
                            </apex:facet>
                            <apex:outputField value="{!o.Primary_Product_Name__c}"/>
                        </apex:column>

                        <apex:column >
                            <apex:facet name="header">
                                <apex:outputPanel >Type</apex:outputPanel>
                            </apex:facet>
                            <apex:outputField value="{!o.Opportunity_Type__c}"/>
                        </apex:column>
                    </apex:pageBlockTable>
                    <apex:outputPanel rendered="{!!flag}" id="noRecordId" >
                        <apex:pageMessage severity="ERROR" summary="No records to display"/>
                    </apex:outputPanel>
                </apex:pageBlock>

                <apex:commandButton value="Skip" style="float:right;width:80px;height:30px;font-weight:bold;" action="{!pageRedirect}" rendered="{!showOpenOpptySection}"/>

            </apex:outputPanel>
        </apex:outputPanel>

        <apex:outputPanel id="contractproductpopup">
            <apex:outputPanel styleClass="popupBackground" layout="block" rendered="{!showContractProductPop}"/>
            <apex:outputPanel styleClass="custPopup" layout="block" rendered="{!showContractProductPop}">
                <apex:pageBlock id="contractProductSection" title="Contract Products of {!contractIdForProduct}">
                    <apex:pageblockTable value="{!ContractProductWrapper}"  var="contractProductRecord" >
                        <apex:column value="{!contractProductRecord.forecastProductName}" headerValue="Forecast Product Name"/>
                        <apex:column value="{!contractProductRecord.currencyCode}" headerValue="Currency Code"/>
                        <apex:column value="{!contractProductRecord.averageRenewalCommit}" headerValue="Baseline Monthly Commit"/>
                        <apex:column value="{!contractProductRecord.averageRenewalUsage}" headerValue="Baseline Monthly Usage"/>
                    </apex:pageblockTable>
                </apex:pageBlock>
                <apex:commandButton value="Close" action="{!closePopup}" rerender="contractproductpopup" status="showSpinner"/>
            </apex:outputPanel>
        </apex:outputPanel>

        <apex:outputPanel id="associatedcontractpopup">
            <apex:outputPanel styleClass="popupBackground" layout="block" rendered="{!showContractsAssociatedToOppty}"/>
            <apex:outputPanel styleClass="custPopup" layout="block" rendered="{!showContractsAssociatedToOppty}">
                <apex:pageBlock id="associatedContractSection" title="Associated contracts">
                    <apex:pageblockTable value="{!associatedContracts}"  var="contract" >
                        <apex:column >
                            <apex:facet name="header">
                                <apex:outputPanel >Name</apex:outputPanel>
                            </apex:facet>
                            <apex:outputLink value="/{!contract.Id}" target="_blank">{!contract.Original_Contract_Id__c}</apex:outputLink>
                        </apex:column>
                        <apex:column value="{!contract.Parent_Contract__c}"/>
                        <apex:column value="{!contract.Order_Id__c}" />
                        <apex:column value="{!contract.Contract_Type__c}" />
                        <apex:column value="{!contract.Parent_Account_Name__c}" />
                        <apex:column value="{!contract.Effective_End_Date__c}" />

                    </apex:pageblockTable>

                </apex:pageBlock>
                <apex:commandButton value="Close" action="{!closeContractsAssociatedToOppty}" rerender="associatedcontractpopup" status="showSpinner"/>
            </apex:outputPanel>
        </apex:outputPanel>


    </apex:form>

    <apex:form id="form2" rendered="{!!noOpenOpps}">
        <apex:actionFunction name="open" action="{!pageRedirect}" status="Opportunitystatus" reRender="form1,Results,ContractResults,noRecordId,oppSection,sf1tblResults,form2"/>
        <apex:actionStatus id="Opportunitystatus">
            <apex:facet name="start">
                <c:enhancedActionStatus BackColor="#ffffff" borderColor="#ffffff" borderSize="2" height="50px" width="150px" ImageUrl="/changemgmt/img/spinner24.gif" Message="Loading..." messageStyle="color:darkred;font-size:11pt;font-weight:bold;"/>
            </apex:facet>
        </apex:actionStatus>
    </apex:form>

    <script>
       var noOpps = {!IF(noOpenOpps, "true", "false")}; ////SFDC-5897 Added
        // var noOpps = Boolean({!noOpenOpps}); //SFDC-5897 Commented
         if(!noOpps)
            open();
    </script>
</apex:page>