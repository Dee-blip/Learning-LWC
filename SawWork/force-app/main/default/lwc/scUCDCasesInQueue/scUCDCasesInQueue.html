<template>
    <div if:true={showCasesinQueue}>
        <c-modal data-id="OpenDescription" class='slds-hide' variant="x-small">
            <div slot="header">
                Case Description
            </div>
            <div class="slds-p-around_medium">
                <lightning-formatted-rich-text class="slds-form-element__static" value={currentRecord.livingSummary}
                    linkify></lightning-formatted-rich-text>
            </div>
        </c-modal>

         <template if:true={showPendingReasonModal}>
            <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true"
                aria-describedby="modal-content-id-2" class="slds-modal slds-fade-in-open modalZIndex">
                <div class="slds-modal__container">
                    <header class="slds-modal__header">

                        <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse"
                            title="Close" onclick={closeChangeOwnerModal}>
                            <lightning-icon icon-name="utility:close" alternative-text="close" variant="inverse"
                                size="small"></lightning-icon>
                        </button>

                        <h2 id="modal-heading-01" class="slds-text-heading_medium slds-hyphenate">
                            Pending Case Reason</h2>
                    </header>
                    <div class="slds-modal__content slds-p-around_medium" id="modal-content-id-2"
                        style="height: 35%;overflow: initial;">
                        <div if:true={showStatusWarning} class="slds-box slds-theme--warning">
                        On clicking save, the case status will change to 'Pending'
                        </div>
                        <br/>
                        <lightning-combobox value={getPendingCasevalue} label="Pending Case Reason" options={getPendingCaseoptions}
                            onchange={handlePendingCaseChange}></lightning-combobox>
                        <br />
                        <div if:true={showPendingCaseOthersReason}>
                            <lightning-input type="text" placeholder="Provide Pending Case Others Reason"
                                onchange={handlePendingReasonCaseChange} value={othersreason} maxlength="254" required
                                label="Pending Case Others Reason">
                            </lightning-input>

                        </div>
                    </div>

                    <footer class="slds-modal__footer">
                        <lightning-button variant="brand" label="Save" onclick={assignReasontoCase}>
                        </lightning-button>
                    </footer>
                </div>
            </section>

            <div class="slds-backdrop slds-backdrop_open"></div>
        </template>

        <template if:true={showChangeOwnerModal}>
            <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true"
                aria-describedby="modal-content-id-2" class="slds-modal slds-fade-in-open modalZIndex">
                <div class="slds-modal__container" style="font-size: 11px; max-width: 42rem">
                    <header class="slds-modal__header">

                        <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse"
                            title="Close" onclick={closeChangeOwnerModal}>
                            <lightning-icon icon-name="utility:close" alternative-text="close" variant="inverse"
                                size="small"></lightning-icon>
                        </button>

                        <h2 id="modal-heading-02" class="slds-text-heading_medium slds-hyphenate">
                            Change Case Owner</h2>
                    </header>

                    <div class="slds-modal__content slds-p-around_medium" id="modal-content-id-3"
                        style="height: 18vh;overflow: initial;">
                        <lightning-layout>
                            <lightning-layout-item size="1" style="
                        padding-top: 1.4rem;">
                                <lightning-button-menu variant="border-filled" icon-name="action:change_record_type"
                                    onselect={handleOnselect}>
                                    <lightning-menu-item value="People" icon-name="utility:adduser" label="People">
                                    </lightning-menu-item>
                                    <lightning-menu-item value="Queues" icon-name="utility:overflow" label="Queues">
                                    </lightning-menu-item>
                                </lightning-button-menu>
                            </lightning-layout-item>
                            <lightning-layout-item size="11">
                                <template if:true={showQueueOwner}>
                                    <c-sc-dynamic-lookup-cmp lookup-label="Queues" search-query={query} key-field="QueueId" label-field="Queue.Name"
                                        icon-name="standard:queue" onrecordselection={onQueueSelection}>
                                    </c-sc-dynamic-lookup-cmp>
                                </template>
                                <template if:true={showUserOwner}>
                                    <lightning-record-edit-form record-id="" object-api-name="Case"
                                        onsubmit={dummySubmit} class="updateFormClass">
                                        <label for="ownerId"
                                            class="slds-form-element__label slds-m-left_xxx-small">Owner</label>
                                        <lightning-input-field id="OwnerId"
                                            field-name="IR_Manual_Invoice_Approved_by__c" variant="label-hidden"
                                            data-id="OwnerId" class="recordFormInput">
                                        </lightning-input-field>
                                    </lightning-record-edit-form>
                                </template>
                            </lightning-layout-item>
                        </lightning-layout>
                    </div>

                    <footer class="slds-modal__footer">
                        <button class="slds-button slds-button_brand" onclick={updateCaseOwner}>Change Owner</button>
                    </footer>
                </div>
            </section>

            <div class="slds-backdrop slds-backdrop_open"></div>
        </template>
<!--Start of lightning datatable-->
        <div style="zoom:90%">
            <div class="slds-grid slds-gutters">
                <div class="slds-col caseTableDiv slds-size_5-of-5">

                    <div class="slds-card slds-page-header" style="height: auto;margin-top: 0px;max-height: 80vh;">
                        <div class="slds-gutters" style="margin-top: 6px;margin-bottom: 6px; ">
                            <div>
                                <template if:true={showspinner}>
                                    <div style="opacity: 0.7;" class="slds-spinner_container">
                                        <lightning-spinner alternative-text="Loading" variant="brand" size="medium">
                                        </lightning-spinner>
                                    </div>
                                </template>
                            </div>
                            <!-- *************************** HEADER **********************************************-->
                            <header class="slds-media_center">

                                <div class="slds-grid">
                                    <div class="slds-media__figure slds-col slds-size_2-of-12">

                                        <ul class="slds-list_horizontal slds-media_center">
                                            <li>
                                                <template if:true={displayCase}>
                                                    <lightning-button-icon icon-name="utility:chevrondown" variant="bare"
                                                                           style="padding-right: 6px; padding-left: 2px;"
                                                                           alternative-text="Collapse" title="Collapse"
                                                                           onclick={hidemyopencasesTable}>
                                                    </lightning-button-icon>
                                                </template>

                                                <template if:false={displayCase}>
                                                    <lightning-button-icon icon-name="utility:chevronright" variant="bare"
                                                                           style="padding-right: 6px; padding-left: 2px;"
                                                                           alternative-text="Collapse" title="Collapse"
                                                                           onclick={showmyopencasesTable}>
                                                    </lightning-button-icon>
                                                </template>
                                            </li>

                                            <li style="margin-right: 5px;">
                                                <lightning-icon icon-name="standard:case" size="medium"></lightning-icon>
                                            </li>

                                            <li>
                                                <div class="slds-media__body">
                                                    <div class="slds-page-header__name">
                                                        <div class="slds-page-header__name-title">
                                                            <h2>
                                                            <span class="slds-text-heading_small slds-truncate"><b>Cases
                                                                    in
                                                                    Queue ({TotalCount}) </b></span>
                                                            </h2>
                                                        </div>
                                                    </div>
                                                    <p class="slds-page-header__name-meta">Updated <lightning-relative-date-time value={Queuenow}>
                                                    </lightning-relative-date-time>

                                                    </p>
                                                </div>
                                            </li>
                                        </ul>
                                    </div>

                                    <div class="slds-col slds-size_4-of-12 slds-large-size_6-of-12 slds-medium-size_4-of-12">
                                        <lightning-button variant="brand" class="changeOwnerButton" disabled
                                                          label="Change Owner" title="Change owner on one or more cases to an individual or a queue"  onclick={openModal}>
                                        </lightning-button>
                                    </div>
                                    <div class="slds-col slds-size_3-of-12 slds-large-size_3-of-12 slds-medium-size_4-of-12 display-horizontal" style="padding-left: 113px">
                                        <lightning-button-menu icon-name="utility:search" icon-size="medium" nubbin
                                                               variant="border-filled" title="Search on fields" alternative-text="Search on fields" >

                                            <div class="slds-panel__body" style="padding-bottom: 0">

                                                <div class="slds-media__body" style="width: max-content">
                                                    <div class="slds-grid slds-grid_align-spread">
                                                        <h3><b>Fields</b></h3>
                                                    </div>

                                                    <div class="slds-p-around_x-small">
                                                        <lightning-checkbox-group options={CasestoSearchOptions}
                                                                                  value={searchColVal} onchange={handleCasestoSearch}
                                                                                  class="searchchkbox"></lightning-checkbox-group>
                                                    </div>
                                                </div>
                                            </div>
                                        </lightning-button-menu>
                                        <div >
                                            <lightning-input class="brandColor" variant="label-hidden"
                                                             type="search"
                                                             onchange={handleKeyUp}
                                                             placeholder="Search Cases...">
                                            </lightning-input>
                                        </div>
                                        <div class="c-ltng-button-menu slds-p-left_small">
                                            <lightning-button-icon label="Filter" variant="border-filled" class="CasesinQmenu c-ltng-button-menu-button" menu-alignment="right"
                                                              icon-name="utility:filterList" alternative-text="Show Filters"
                                                              title="Show Filters" style="float:right;" onclick={toggleFilterVisibility}>
                                            </lightning-button-icon>
                                            <template if:true={filterVisibility}>
                                                <div class="backdrop" onclick={onBackdropClick} data-id="filters"></div>
                                                <div class="c-ltng-button-menu-content show-right-to-left">
                                                    <div class="slds-page-header" style="padding-bottom: 4px;padding-top: 4px;background-image: linear-gradient(45deg, #08547d, #0099cc);">
                                                        <header class="slds-media slds-media_center slds-has-flexi-truncate">
                                                            <div class="slds-media__figure slds-col slds-size_1-of-4">

                                                                <ul class="slds-list_horizontal slds-media_center">

                                                                    <li style="margin-right: 5px;">
                                                                        <lightning-icon icon-name="action:filter" size="x-small">
                                                                        </lightning-icon>
                                                                    </li>

                                                                    <li>
                                                                        <div class="slds-media__body">
                                                                            <div class="slds-page-header__name">
                                                                                <div class="slds-page-header__name-title">
                                                                                    <h2><span class="slds-text-heading_small" style="color:white"><b>Queue Filters</b></span></h2>
                                                                                </div>
                                                                            </div>
                                                                            <p class="slds-page-header__name-meta"
                                                                               style="color:white">
                                                                                {displaymessage}
                                                                            </p>
                                                                        </div>
                                                                    </li>
                                                                </ul>
                                                            </div>
                                                            <div style="width: 100%">
                                                                <lightning-button-icon data-id="filters" onclick={onBackdropClick} class="slds-float_right slds-p-right_x-small" icon-name="action:close" size="large" variant="bare-inverse"></lightning-button-icon>
                                                            </div>
                                                        </header>
                                                    </div>
                                                    <div class="slds-modal__content slds-p-around_medium"
                                                         style="border-top: 1px solid #a7a9ab;">

                                                        <lightning-tabset data-id="filters-tabset" active-tab-value="savedfilters">
                                                            <lightning-tab label="My Filters" value="savedfilters" onactive={handleActiveTab}>

                                                                <div style="min-width: 225px; border-right: 1px solid #e7e7e7;">
                                                                    <lightning-layout>

                                                                        <lightning-layout-item size="12" padding="around-small">
                                                                            <div style="height: 16rem">
                                                                                <div if:true={showNewFilterButton}>
                                                                                    <lightning-button variant="brand" label="Create a new filter" onclick={newFilter}></lightning-button>
                                                                                    <br></br>
                                                                                </div>
                                                                                <div if:true={showNewFilterCreation}>
                                                                                    <div class="slds-box"
                                                                                         style="background-color: rgb(242, 242, 242);padding-top: 2px;">
                                                                                        <lightning-layout>
                                                                                            <lightning-layout-item size="11">
                                                                                                <lightning-input data-id="filterName" type="text"
                                                                                                                 class="filternamefield"
                                                                                                                 onchange={handleValueChange}
                                                                                                                 label="New Filter Name : (After typing the filter name, select the desired filters from the next 2 tabs and hit save!)"
                                                                                                                 maxlength="20" required>
                                                                                                </lightning-input>
                                                                                            </lightning-layout-item>

                                                                                            <!-- <lightning-layout-item size="1"
                                                                                                 style=" padding-top: 22px;">
                                                                                                 <lightning-button-icon
                                                                                                     icon-name="utility:save"
                                                                                                     class="slds-m-left_xx-small"
                                                                                                     title="Save" variant="brand"
                                                                                                     onclick={handleQueueSave}>
                                                                                                 </lightning-button-icon>
                                                                                             </lightning-layout-item>-->
                                                                                        </lightning-layout>
                                                                                        <lightning-layout class="slds-m-top_small">
                                                                                            <lightning-layout-item>
                                                                                                <lightning-button variant="brand" label="Next" onclick={onNextFilterTabClick}></lightning-button>
                                                                                                <lightning-button class="slds-m-left_x-small" label="Cancel" onclick={onFilterCreationCancel}></lightning-button>
                                                                                            </lightning-layout-item>
                                                                                        </lightning-layout>
                                                                                    </div>
                                                                                    <br></br>
                                                                                </div>

                                                                                <template if:false={showNewFilterCreation}>
                                                                                <table
                                                                                        class="slds-table slds-table_cell-buffer slds-table_bordered slds-table_col-bordered"
                                                                                        style="width:100%">
                                                                                    <thead>
                                                                                    <tr class="slds-line-height_reset">

                                                                                        <th class="slds-text-title_caps" scope="col"
                                                                                            style="
                                                                        background: #1d5873;
                                                                        color: white; ">
                                                                                            <div class="slds-truncate">Filter Name
                                                                                            </div>
                                                                                        </th>

                                                                                        <th class="slds-text-title_caps" scope="col"
                                                                                            style="
                                                                        background: #1d5873;
                                                                        color: white;">
                                                                                            <div class="slds-truncate">Actions</div>
                                                                                        </th>
                                                                                    </tr>
                                                                                    </thead>
                                                                                    <tbody>
                                                                                    <template for:each={SavedFilters}
                                                                                              for:item='cus'>
                                                                                        <tr class="slds-hint-parent"
                                                                                            key={cus.label}>
                                                                                            <td>
                                                                                                {cus.label}
                                                                                            </td>
                                                                                            <td>
                                                                                                <lightning-button-icon
                                                                                                        icon-name="utility:preview"
                                                                                                        value={cus.value}
                                                                                                        onclick={previewFilter}
                                                                                                        class="slds-m-left_xx-small">
                                                                                                </lightning-button-icon>


                                                                                                <lightning-button-icon
                                                                                                        icon-name="utility:delete"
                                                                                                        value={cus.value}
                                                                                                        onclick={deleteFilter}
                                                                                                        class="slds-m-left_xx-small">
                                                                                                </lightning-button-icon>
                                                                                            </td>
                                                                                        </tr>
                                                                                    </template>
                                                                                    </tbody>
                                                                                </table>
                                                                                </template>
                                                                            </div>
                                                                        </lightning-layout-item>
                                                                    </lightning-layout>
                                                                </div>


                                                            </lightning-tab>

                                                            <lightning-tab label="Filter based on Queues" value="Queue" onactive={handleActiveTab}>
                                                                <lightning-layout>
                                                                    <lightning-layout-item size="6">
                                                                        <div style="height: 18rem">

                                                                            <lightning-datatable data={queuedata}
                                                                                                 columns={queuecolumns} column-widths-mode="auto"
                                                                                                 key-field=queueId selected-rows={selectedQueues}
                                                                                                 onrowselection={getSelectedQueues}
                                                                                                 default-sort-direction={defaultSortDirection}
                                                                                                 sorted-direction={QueuesortDirection}
                                                                                                 sorted-by={QueuesortedBy}
                                                                                                 onsort={onHandleQueueSort}>

                                                                            </lightning-datatable>
                                                                        </div>
                                                                    </lightning-layout-item>
                                                                    <lightning-layout-item size="6" padding="around-small">
                                                                        <h3 class="slds-text-title_caps slds-truncate">
                                                                            <b>Severity</b>
                                                                        </h3>
                                                                        <div class="slds-m-top_x-small slds-box">
                                                                            <lightning-checkbox-group name="Checkbox Group"
                                                                                                      options={SevOptions} value={Sevvalue}
                                                                                                      class="inlinecheckbox" onchange={handleSevChange}>
                                                                            </lightning-checkbox-group>
                                                                        </div>
                                                                        <br></br>
                                                                        <h3 class="slds-text-title_caps slds-truncate"><b>Status</b>
                                                                        </h3>
                                                                        <div class="slds-m-top_x-small slds-box">
                                                                            <lightning-checkbox-group name="Checkbox Group"
                                                                                                      options={StatusOptions} value={Statusvalue}
                                                                                                      onchange={handleStatusChange}>
                                                                            </lightning-checkbox-group>
                                                                        </div>
                                                                    </lightning-layout-item>
                                                                </lightning-layout>
                                                            </lightning-tab>

                                                            <lightning-tab label="Filter based on GRAZT (Optional)" value="Map" onactive={handleActiveTab}>
                                                                <div style="height: 18rem">

                                                                    <lightning-datatable data={terrdata} columns={terrcolumns}
                                                                                         column-widths-mode="auto" key-field=territory
                                                                                         onrowselection={getSelectedTerritories}
                                                                                         selected-rows={selectedRowsfromFilter}
                                                                                         default-sort-direction={defaultSortDirection}
                                                                                         sorted-direction={TerrsortDirection}
                                                                                         sorted-by={TerrsortedBy} onsort={onHandleTerritorySort}>

                                                                    </lightning-datatable>
                                                                </div>
                                                            </lightning-tab>
                                                        </lightning-tabset>

                                                        <template if:true={showFilterFooter}>
                                                            <div class="slds-has-divider_top-space" role="separator"></div>
                                                            <div class="slds-modal__footer" style="padding: 5px; text-align: center;border: none; background-color: white;box-shadow: none;">
                                                                <lightning-button icon-name="utility:save" variant="brand" label="Save filter selection!"  class="savefilterbtn slds-m-left_x-small" onclick={editFilter}></lightning-button>
                                                                <lightning-button label="Cancel" class="slds-m-left_x-small" onclick={onFilterCreationCancel}></lightning-button>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                        <lightning-button-menu icon-name="utility:settings"  variant="border-filled"
                                                               menu-alignment="right" title="Customize Columns" alternative-text="Customize Columns" nubbin>
                                            <div class="slds-panel__body" style="padding-bottom: 0">

                                                <div class="slds-media__body" style="width: max-content">
                                                    <div class="slds-grid slds-grid_align-spread">
                                                        <h3><b>Columns to display</b></h3>
                                                    </div>

                                                    <div class="slds-p-around--x-small">
                                                        <lightning-checkbox-group options={AllOpenCasesColOptions}
                                                                                  value={AllOpenCasesColvalue} onchange={handleallopenColChange}>
                                                        </lightning-checkbox-group>

                                                    </div>
                                                </div>
                                            </div>

                                        </lightning-button-menu>
                                    </div>

                                    <div class="slds-col slds-size_1-of-12 slds-text-align_right slds-gutters">
                                        <button class="slds-button" onclick={getCasesData}>
                                            <lightning-icon icon-name="action:refresh" title="Click to refresh" alternative-text="Refresh Dashboard"
                                                            size="x-small">
                                            </lightning-icon>
                                        </button>
                                    </div>
                                </div>
                            </header>
                        </div>
                    </div>

                    <div class="datatableStyle" style="padding-top: 0px; border-radius: 4px;">
                        <div id="divForDatatable" class="panelCasesInQueue" style="height:65vh;">

                            <lightning-datatable data={data} columns={columns} key-field=caseRecId
                                column-widths-mode="auto" wrap-text-max-lines=2 onrowaction={handleRowActions}
                                enable-infinite-loading onloadmore={loadMoreData}
                                default-sort-direction={defaultSortDirection} sorted-direction={sortDirection}
                                sorted-by={sortedBy} onsort={onHandleSort} class="casesinQDatatable"
                                onrowselection={getSelectedCaseIds} selected-rows={selectedcasefromqueue}
                                max-row-selection=50>
                            </lightning-datatable>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</template>