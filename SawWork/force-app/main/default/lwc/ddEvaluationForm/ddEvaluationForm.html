<template>
    <article class="slds-card" style="border: 0; box-shadow: none;">
        <div class="slds-card__header slds-grid slds-p-top_medium slds-p-bottom_xx-small">
            <header class="slds-media slds-media_center slds-has-flexi-truncate">
                <div class="slds-media__figure">
                    <lightning-icon icon-name="action:new_lead" size="x-small" alternative-text="Deal Desk"
                        title="Deal Desk"></lightning-icon>
                </div>
                <div class="slds-media__body">
                    <h2 class="slds-card__header-title">
                        <div class="slds-card__header-link slds-truncate"
                            style="font-size:1.25rem; font-weight: 400; color: #6cb472"
                            title="GSS Deal Evaluation Desk">
                            <span>GSS Deal Evaluation Desk</span>
                        </div>
                    </h2>
                </div>
                <div class="slds-no-flex" style="width:30%;">
                    <div onclick={openHelpPage} style="outline: none; cursor:pointer">
                        <lightning-button-icon icon-name="utility:help" size="x-small" variant="border-filled"
                            alternative-text="help" title="help link"></lightning-button-icon>
                        <span class="slds-p-left_xx-small sub-text"
                            style="color:rgb(112, 110, 107); vertical-align:center;">Help Guide</span>
                    </div>
                    <div onclick={openBugReport} style="outline: none; cursor:pointer; display:flex; padding-top: 5px">
                        <div style="display: inline-block; align-self: center;">
                            <lightning-button-icon icon-name="utility:setup" size="x-small" variant="border-filled"
                            alternative-text="help" title="report bug/ enhancement link"></lightning-button-icon>
                        </div>
                        <span class="slds-p-left_xx-small sub-text"
                            style="color:rgb(112, 110, 107); vertical-align:center; line-height: 1.5;">Report a bug/ enhancement</span>
                    </div>
                </div>
            </header>
        </div>
<!-- ************************** Start of Form ************************** -->
        <div class="slds-card__body slds-card__body_inner">
            <div class="slds-form">
                <!-- Account Search Combo box -->
                <c-combo-box options={accList} props={accComboProps} placeholder="Account Name / Id" onchange={handleAccChange}
                    value={accId} data-inpid="Account" onselect={handleAccSel} variant="label-stacked" label="Account"
                    no-results-msg={accNoResultsMsg} required disabled={formConfig.account.disabled}>
                </c-combo-box>

                <!-- Account related info - AKAM ID, Contract Info, Customer MRR  -->
                <lightning-layout class={accInfoCss}>
                    <lightning-layout-item size="8">
                        <div class="slds-p-left_xx-small slds-p-bottom_x-small sub-text">Account Id:
                            {akamAccId} </div>
                    </lightning-layout-item>
                    <lightning-layout-item size="4">
                        <div class="slds-media link" onclick={toggleModal} data-toggleid="contract-info">
                            <div class="slds-media__figure">
                                <lightning-icon icon-name="utility:description" size="xx-small"></lightning-icon>
                            </div>
                            <div class="slds-media__body sub-text">Contract Info</div>
                        </div>
                        <div class="slds-media link" onclick={toggleModal} data-toggleid="customer-mrr">
                            <div class="slds-media__figure">
                                <lightning-icon icon-name="utility:user" size="xx-small"></lightning-icon>
                            </div>
                            <div class="slds-media__body sub-text">Customer MRR</div>
                        </div>
                    </lightning-layout-item>
                </lightning-layout>

                <!-- GSS Product Picklist -->
                <lightning-combobox label="GSS Product" variant="label-stacked" options={productOpt} required disabled={formConfig.product.disabled}
                    class="gssprods" data-inpid="GSS Product" value={prodSelected} onchange={handleProdSelected}>
                </lightning-combobox>

                <!-- Product Type Pick List - picklist options updated dynamically based on selected product -->
                <template if:true={productTypePickValues}>
                    <lightning-combobox label="Product Type" variant="label-stacked" options={productTypePickValues} disabled={formConfig.product.disabled}
                        data-inpid="Product Type" required value={subProdSelected} onchange={handleSubProdSelected}>
                    </lightning-combobox>
                </template>
                <!-- Show below fields Only for Other Product : Product Name, Product Description, Approval Type-->
                <div if:true={isOtherProd}>
                    <!-- Product Name -->
                    <lightning-input label="Product Name" variant="label-stacked" type="text" required class="gssprods" max-length="250"
                        data-inpid="Product Name" placeholder="Product Name"></lightning-input>
                    
                    <!-- Product Description -->
                    <lightning-input label="Product Description" variant="label-stacked" type="text" required max-length="250"
                        class="gssprods" data-inpid="Product Description" placeholder="Product Description">
                    </lightning-input>

                    <!-- Approval Type Picklist -->
                    <lightning-combobox label="Approval Type" variant="label-stacked" options={otherProdApprovalTypes}
                        required class="gssprods" data-inpid="Approval Type" placeholder="Select Type"
                        onchange={approvalTypeChange}>
                    </lightning-combobox>
                </div>              
                
                <!-- Package Customization - NOT visible for "Other" Product -->
                <lightning-layout if:false={isOtherProd} class="slds-m-vertical_small slds-m-horizontal_xx-small pack-border"
                    vertical-align="center" horizontal-align="stretch">
                    <lightning-layout-item size="8" class="slds-p-left_x-small">
                        <div style="display:inline-block;">Total Custom Package Hrs/Month: </div>
                        <div style="color:#ea4e4e; font-size:1rem; font-weight:700; float:right"> {requestedHours}
                        </div>
                    </lightning-layout-item>

                    <lightning-layout-item size="4" >
                        <lightning-button if:false={isLoeCalcNeeded} label='Customise' disabled={disableCustomization}
                            class="slds-float_right" icon-name="utility:settings" variant="brand" data-toggleid="package-cust"
                            onclick={toggleModal} >
                        </lightning-button>

                        <lightning-button if:true={isLoeCalcNeeded} label='Configure' disabled={disableCustomization}
                            class="slds-float_right" icon-name="utility:settings" variant="brand" data-toggleid="loe-calc"
                            onclick={toggleModal} >
                        </lightning-button>
                    </lightning-layout-item>
                </lightning-layout>

                <!-- Currency Picklist -->
                <lightning-combobox label="Local Currency" variant="label-stacked" options={currencyOptions} required 
                    class="gssprods" data-inpid="Local Currency" value={selectedCurrKey} onchange={handleCurrChange}>
                </lightning-combobox>
                <!-- Price in Pricelist (Only for Other Product)-->
                <c-input-currency if:true={isOtherProd} label={otherPriceInPriceListLabel} variant="label-stacked" required
                                data-inpid="Price in Pricelist" placeholder="000,000" currency={selectedCurrKey} step="1"> <!--   -->
                </c-input-currency>              
                <!-- Requested Price -->
                <c-input-currency label={requestPriceLabel} value={requestedPrice} variant="label-stacked" required
                    data-inpid="Requested Price" placeholder="000,000" currency={selectedCurrKey} disabled={formConfig.reqPrice.disabled}
                    onvaluechange={handleReqPriceChange} step="1">
                </c-input-currency>

                <!-- USD Equivivalent value of Requested Price - Visible only when Local Currency != USD  -->
                <div class="slds-p-around_xx-small slds-text-body_regular"
                    style="display: flex; color: rgb(0, 0, 0); margin-top: -10px; justify-content: flex-end"
                    if:false={isUsd}>
                    <div style="display:inline-block;">Equivalent USD: </div>
                    <div class="slds-p-horizontal_medium">
                        <lightning-formatted-number value={reqPriceInUsd} format-style="currency" currency-code="USD">
                        </lightning-formatted-number>
                    </div>
                </div>

                <!-- Show below fields Only for Other Product : Amount of Discount, Explanation & Justification-->              
                <div if:true={isOtherProd}>
                    <!-- Amount of Discount -->
                    <lightning-input if:true={showAmountOfDiscount} label="Amount of Discount(%)" variant="label-stacked"
                        type="number" class="gssprods" disabled value={discount} ></lightning-input>

                    <!-- Explanation & Justification -->
                    <lightning-input label="Explanation & Justification" variant="label-stacked"
                        type="text" max-length="250" class="gssprods" data-inpid="Explanation & Justification" placeholder="Enter Text">
                    </lightning-input>

                </div>
              
                <!-- NAP Customer checkbox -->
                <lightning-input type="checkbox" label="NAP Customer" class="nap-cust" checked={isNapCustomer} disabled={formConfig.napCust.disabled}>
                </lightning-input>
            </div>
        </div>
        
        <!-- Evaluate Button - handleEvaluate will fire "evaluate" event with all form data, which will be handled by ddDealDesk comp -->
        <div class="slds-form-footer">
            <div style=" text-align:right;" if:false={isOtherProd}>
                <button class="button grow" onclick={handleEvaluate} >
                    Evaluate
                </button>
            </div>
            <div style=" text-align:right;" class="slds-m-bottom_xx-large" if:true={isOtherProd}>
                <button class="button grow" onclick={hanldeOtherProdSubmit}>
                    Submit
                </button>
            </div>
        </div>
        <!-- ************************** End of Form ************************** -->
    </article>

    <!-- Customer MRR Modal - show it on click of "Customer MRR" link -->
    <c-modal data-id="customer-mrr" variant="small" if:true={akamAccId}>
        <div slot="header">
            Customer MRR
        </div>

        <lightning-datatable key-field="servProd" data={mrrData} columns={mrrColumns} hide-checkbox-column
            class="slds-table_striped table-customization">
        </lightning-datatable>
    </c-modal>

    <!-- Contract Info Modal - show it on click of "Contract Info" link -->
    <c-modal data-id="contract-info" variant="medium" if:true={akamAccId}>
        <div slot="header">
            Contract Info for {akamAccId}
        </div>
        <c-dd-contract-info akam-account-id={akamAccId}></c-dd-contract-info>
    </c-modal>

    <!-- Package Customisation Component Modal - show it on click of "Customise" button -->
    <c-modal data-id="package-cust" variant="x-small" if:true={prodSelected}>
        <div slot="header">
            Customize Total Package Hours For {prodSelected}
            <template if:true={subProdSelected}>
                &nbsp;> {subProdSelected}
            </template>
        </div>

        <c-dd-package-customization prod-selected={prodSelected} sub-prod-selected={subProdSelected} 
                        comp-data={packCompDefaultValues} 
            oncustomization={handleReqHoursChange}>
        </c-dd-package-customization>
    </c-modal>

    <!-- LOE Calculator modal - show it on click of "Configure" button -->
    <c-modal data-id="loe-calc" variant="x-small" if:true={prodSelected}>
        <div slot="header">
            Select LOE Value
        </div>

        <c-dd-loe-calculator data-toggleid="loe-calc" akam-acc-id={akamAccId} loeid={loeid} loehours={requestedHours} onloe={handleLoe} oncancel={toggleModal}>
        </c-dd-loe-calculator>

        <div slot="footer">
            <!-- Please note that LoE Calculator requests with status "Request Completed" only are fetched for an account -->
        </div>
    </c-modal>
</template>