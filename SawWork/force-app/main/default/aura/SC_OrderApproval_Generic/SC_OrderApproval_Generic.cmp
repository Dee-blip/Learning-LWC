<!--========================================================================================================+
    Component name      :   SC_OrderApproval_Generic
    Author              :   Vikas
    Created             :   06-Feb-19
    Purpose             :   This is a component to show custom buttons in Order Approval and Case Pages

    Last Modified 	Developer	Purpose            
    ============= 	=========	============ 
    06-Feb-19     	Vikas  		Initial Development(JIRA:ESESP-1702)
    12 May 2021     Vandhana    Added check to hide Raise New Request for MPCC created Cases
    23 Sep 2021     Aravind     ESESP-4261: Added warning when approving OM case with pending related cases
+=========================================================================================================-->
<aura:component controller="SC_OrderApprovals_LightningCtrl" implements="force:appHostable,flexipage:availableForAllPageTypes,flexipage:availableForRecordHome,force:hasRecordId,forceCommunity:availableForAllPageTypes,force:lightningQuickAction"  access="global">
    <!--Variable which decides from which page is the component called-->
    <aura:attribute name="action" type="String" access="global"/>
    <aura:handler name="init" value="{!this}" action="{!c.doInit}"/>
    
    <aura:attribute name="caseobj" type="Object" access="global"/>
    <aura:attribute name="isCasePage" type="boolean" default="false" />
    <aura:attribute name="isOAPage" type="boolean" default="false" />
    
    <aura:attribute name="isOpenNewRequest" type="boolean" default="false" />
    <aura:attribute name="isOpenNewEscalateCase" type="boolean" default="false" />
    <aura:attribute name="isOpenNewCase" type="boolean" default="false" />
    <aura:attribute name="showEscalateCase" type="boolean" default="false" />
    <aura:attribute name="isOpenCase" type="boolean" default="false" />
    <aura:attribute name="isClosedCase" type="boolean" default="true" />
    <aura:attribute name="isMPCCCase" type="boolean" default="false" />

    <aura:attribute name="closeOACase" type="boolean" default="false" />
    <aura:attribute name="today" type="Date" />
    <aura:attribute name="Spinner" type="Boolean" default="false" />
    
    <aura:attribute name="reopenCaseModal" type="boolean" default="false" />
    <aura:attribute name="closeCaseModal" type="boolean" default="false" />
    <aura:attribute name="isCloseCaseWarningShown" type="boolean" default="false" />
    <aura:attribute name="warningAckCheckboxValue" type="boolean" default="false" />
    <aura:attribute name="recordType" type="String" />
    <aura:attribute name="ADCreateModal" type="boolean" default="false" />
    <aura:attribute name="popupMsg" type="String" />
    <aura:attribute name="isAutoClose" type="boolean" default="false" />
    <aura:attribute name="isCPQCase" type="boolean" default="false" />
    <aura:attribute name="isClosedOpp" type="boolean" default="true" />
    <aura:attribute name="reOpenReason" type="String" default="" />
    <aura:attribute name="reopenReasonValues" type="List"/>
    <aura:handler event="lightning:tabRefreshed" action="{!c.doInit}"/>
    
    <aura:if isTrue="{!v.Spinner}">
        <div aura:id="spinnerId" class="slds-spinner_container">
            <div class="slds-spinner--brand  slds-spinner slds-spinner--medium slds-is-fixed" role="alert">
                <span class="slds-assistive-text">Loading</span>
                <div class="slds-spinner__dot-a"></div>
                <div class="slds-spinner__dot-b"></div>
            </div>
        </div>
    </aura:if>
    
    <!--Components open from Case Page-->
    <aura:if isTrue="{!v.isOpenNewRequest}">
        <c:SC_NewApprovalDetails caseRecordId="{!v.recordId}" action="{!v.action}"/>
    </aura:if>
    

    <!--Custom Buttons Code-->
    <div align="left">
        <lightning:buttonGroup >
            <!--To show buttons on Case Page-->
            <aura:if isTrue="{!v.isCasePage}">
                <aura:if isTrue="{!!v.isClosedCase}">
                    <aura:if isTrue="{!!v.isMPCCCase}">
                        <lightning:button aura:id="newRequestId" label="Raise New Request" onclick="{!c.openApprovalDetails}"/>
                    </aura:if>
                    <lightning:button label="Close Case" onclick="{!c.closeOACase}"/>
                </aura:if>
                <!--<aura:if isTrue="{!and(!v.isAutoClose , v.isClosedCase) }">
                    <lightning:button label="Reopen Case" onclick="{!c.reopenOACase}"/>
                </aura:if>-->
                <aura:if isTrue="{!and(!v.isClosedOpp , v.isClosedCase) }">
                    <lightning:button label="Reopen Case" onclick="{!c.reopenOACase}"/>
                </aura:if>
                
                <!--<aura:if isTrue="{!and(!v.isAutoClose , v.isClosedCase) }">
                    <lightning:button label="Reopen Case" onclick="{!c.reopenOACase}"/>
                    <aura:set attribute="else">
                        <aura:if isTrue="{!and(!v.isClosedOpp, v.isAutoClose , v.isClosedCase) }">
                            <lightning:button label="Reopen Case" onclick="{!c.reopenOACase}"/>
                        </aura:if>
                    </aura:set>
                </aura:if>-->
                
            </aura:if>
        </lightning:buttonGroup>
    </div>
    
    <!-- POP-UP TO CREATE APPROVAL REQUEST -->
    <!--Use "slds-m-around_xx-large" class to add standard X-Large padding to the component--> 
    <aura:if isTrue="{!v.ADCreateModal}">
        <div class="slds-m-around_large">
            <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true" aria-describedby="modal-content-id-1" class="slds-modal slds-fade-in-open">
                <div class="slds-modal__container">
                    
                    <header class="slds-modal__header">
                        <lightning:buttonIcon iconName="utility:close"
                                              onclick="{!c.closeCADModal}"
                                              alternativeText="close"
                                              variant="bare-inverse"
                                              class="slds-modal__close"/>
                        
                        <h3 id="modal-heading-01" class="slds-text-heading_medium slds-hyphenate">Create Approval Request</h3>
                    </header>
                    
                    <div class="slds-modal__content slds-p-around_medium" id="modal-content-id-1">
                        {!v.popupMsg}
                    </div>
                    
                    <div class="slds-modal__footer" style="padding:5px">
                        <lightning:button variant="neutral" 
                                          label="OK"
                                          title="OK"
                                          onclick="{!c.closeCADModal}"/>
                    </div>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </div>
    </aura:if>
    <!-- ============================================================================= -->
    
    
    <!-- RE-OPEN MODAL CODE -->
    <!--Use "slds-m-around_xx-large" class to add standard X-Large padding to the component--> 
    <aura:if isTrue="{!v.reopenCaseModal}">
        <div class="slds-m-around_large">
            <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true" aria-describedby="modal-content-id-1" class="slds-modal slds-fade-in-open">
                <div class="slds-modal__container">
                    
                    <header class="slds-modal__header">
                        <lightning:buttonIcon iconName="utility:close"
                                              onclick="{!c.closeRModal}"
                                              alternativeText="close"
                                              variant="bare-inverse"
                                              class="slds-modal__close"/>
                        
                        <h3 id="modal-heading-01" class="slds-text-heading_medium slds-hyphenate">Re-open Case</h3>
                    </header>
                    <div class="slds-modal__content slds-p-around_medium" id="modal-content-id-1">
                        <lightning:input label="Status" value="Reopened" readonly ="true"/>
                        <lightning:select name="Re_open_Reason_Code" label="Re-open Reason Code" required="true" value="{!v.reOpenReason}">
                            <option value="">--None--</option>
                            <aura:iteration items="{!v.reopenReasonValues}" var="option">
                                <option text="{!option}" value="{!option}" />
                            </aura:iteration>
                        </lightning:select>
                        
                    </div>
                    
                    <div class="slds-modal__footer" style="padding:5px">
                        	<lightning:button variant="brand" 
                                          label="Re-open!"
                                          title="Re-open!"
                                          disabled="{!empty(v.reOpenReason)}"
                                          onclick="{!c.reopenCaseMethod}"/>
                        <lightning:button variant="neutral" 
                                          label="Cancel"
                                          title="Cancel"
                                          onclick="{!c.closeRModal}"/>
                    </div>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </div>
    </aura:if>
    <!-- ============================================================================= -->
    
    <!-- CLOSE CASE MODAL CODE -->
    <aura:if isTrue="{!v.closeCaseModal}">
        <div>
            <section role="dialog" tabindex="-1" aria-labelledby="modal-heading-01" aria-modal="true" aria-describedby="modal-content-id-1" class="slds-modal slds-fade-in-open">
                <div class="slds-modal__container">
                    
                    <header class="slds-modal__header">
                        <lightning:buttonIcon iconName="utility:close"
                                              onclick="{!c.closeCModal}"
                                              alternativeText="close"
                                              variant="bare-inverse"
                                              class="slds-modal__close"/>
                        <h2 id="modal-heading-01" class="slds-text-heading_medium slds-hyphenate">Close Case</h2>
                    </header>
                    
                    <div class="slds-modal__content slds-p-around_medium" id="modal-content-id-1">
                        <lightning:recordEditForm aura:id="recordCloseForm"
                                                  recordId="{!v.caseobj.Id}"
                                                  recordTypeId="{!v.caseobj.RecordTypeId}"
                                                  objectApiName="Case">
                            <div class="{!v.isCloseCaseWarningShown?'':'slds-hide'}">
                                <div class="slds-notify_container slds-is-relative">
                                    <div class="slds-notify slds-notify_toast slds-theme_warning close-case-warning-message" role="alert">
                                        <p>
                                            <b>Warning:</b> There are currently other pending cases related to this Order Approval.
                                            Please make sure you have confirmed any relevant requests and cases related to the
                                            approval you are providing have been obtained.
                                        </p>
                                    </div>
                                </div>
                                <lightning:input type="checkbox" aura:id="warningAckCheckbox" class="warning-ack-checkbox"
                                                 label="I acknowledge this warning and want to close this case anyway." name="warningAckCheckbox"
                                                 checked="{!v.warningAckCheckboxValue}" required="true" onchange="{!c.handleWarningAckCheckboxChange}"/>
                            </div>
                            <!--<lightning:inputField fieldName="Status" value="Closed-Approved" aura:id="statusValue"/>-->
                            <lightning:select name="statusValue" label="Status" aura:id="statusValue" class="{!v.isCloseCaseWarningShown?'slds-hide':''}">
                                <option value="Closed-Approved">Closed-Approved</option>
                                <option value="Closed-Auto Approved">Closed-Auto Approved</option>
                                <option value="Closed-Approval Not Needed">Closed-Approval Not Needed</option>
                                <option value="Closed-Insufficient Information">Closed-Insufficient Information</option>
                                <aura:if isTrue="{!v.isCPQCase}">
                                	<option value="Closed-Quote Term Updated">Closed-Quote Term Updated</option>
                                    <option value="Closed-Quote Approved">Closed-Quote Approved</option>
                                </aura:if>
                            </lightning:select>
                        </lightning:recordEditForm>
                    </div>
                    
                    <!--<div class="slds-modal__content slds-p-around_medium" id="modal-content-id-1">
                        <h3>Are you sure you want to Close the Case?</h3>
                    </div>-->
                    
                    <footer class="slds-modal__footer">
                        <lightning:button variant="brand" 
                                          label="Close Case!"
                                          title="Close Case!"
                                          onclick="{!c.closeCaseMethod}"/>
                        <lightning:button variant="neutral" 
                                          label="Cancel"
                                          title="Cancel"
                                          onclick="{!c.closeCModal}"/>
                    </footer>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </div>
    </aura:if>
    
</aura:component>